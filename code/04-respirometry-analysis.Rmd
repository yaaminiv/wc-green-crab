---
title: "04-respirometry-analysis"
author: "Yaamini Venkataraman"
date: '2023-10-17'
output: html_document
---

I will analyze the respirometry data from the experiment. I want to compare *C. maenas* rate of oxygen consumption between treatments and over time. 

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/04-respirometry-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, include=FALSE}
#if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages("tidyverse")
#if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages("RColorBrewer")
#if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages("lubridate")
#if ("respirometry" %in% rownames(installed.packages()) == 'FALSE') install.packages("respirometry")
#if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages("gridExtra")
#if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages("broom")
# if ("patchwork" %in% rownames(installed.packages()) == 'FALSE') install.packages("patchwork")
# if ("grid" %in% rownames(installed.packages()) == 'FALSE') install.packages('grid')
# if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix')
require(tidyverse)
require(RColorBrewer)
require(lubridate)
require(respirometry)
require(gridExtra)
require(broom)
require(patchwork)
require(grid)
require(plotrix)
```

```{r}
sessionInfo()
```

# Import data

At each time point, I have data for nine tanks (three treatments, three tanks/treatment). Each tank has data for four probes, but only three 1-3 were used to collect data. I will import data for each day in one file using `readr`, then ensure I have the correct columns.

```{r}
test <- read_delim("../../data/respiration/20230705/tank2_20230705.txt", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:3, 5:8, 9, 13)) #Import data. Skip the first 20 rows
colnames(test) <- c("date", "time", 
                    "dt_s", "perc_air_sat_1", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(test) #Confirm import
```

### 2022-07-05

```{r}
files20230705 <- fs::dir_ls(path = "../../data/respiration/20230705/", glob = "*_20230705.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in 20230705.txt. * = wildcard
files20230705 #Confirm the list has the correct files
```

```{r}
dat20230705 <- read_delim(files20230705, id = "tank", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:4, 6:9, 10, 14)) #Import data using "tank" as an ID column for all files in the designated list. Specify tab-delimited files and skip the first 20 lines. There are no column names. Select data from all four probes. Use all date/time columns since some probes ran for longer than others.
colnames(dat20230705) <- c("tank", "date", "time", "dt_s", "perc_air_sat_1", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(dat20230705) #Confirm import
```

I need to change the date for all measurements to 7/5/2023. Even though I measured the three treatments on separate days, it will be easier visually to look at things on a single day.

```{r}
dat20230705 <- dat20230705 %>%
  mutate(., tank = str_sub(tank, 33, 37)) %>%
  mutate(., day = rep(7, times = nrow(dat20230705))) %>%
  mutate(., treatment = case_when(tank == "tank1" ~ "5C",
                                  tank == "tank2" ~ "15C",
                                  tank == "tank3" ~ "25C",
                                  tank == "tank4" ~ "5C",
                                  tank == "tank5" ~ "15C",
                                  tank == "tank6" ~ "25C",
                                  tank == "tank7" ~ "5C",
                                  tank == "tank8" ~ "15C",
                                  tank == "tank9" ~ "25C")) %>%
  mutate(., perc_air_sat_4 = case_when(tank == "tank2" ~ as.character(perc_air_sat_1),
                                       tank != "tank2" ~ perc_air_sat_4)) %>%
  select(-perc_air_sat_1) %>%
  mutate(., perc_air_sat_2 = as.numeric(perc_air_sat_2)) %>%
  mutate(., perc_air_sat_4 = as.numeric(perc_air_sat_4)) #Isolate tank ID from the file path. Add day and treatment information. For these trials, tank 2 used probe 1, 2, and 3, but all the others used probes 2, 3, and 4. Use case_when to copy perc_air_sat_1 information to perc_air_sat_4 for tank 2, then remove perc_air_sat_1. Convert perc_air_sat_2 and perc_air_sat_4 to numeric columns
head(dat20230705) #Confirm tank and treatment information
```

### 2023-07-12

```{r}
files20230712 <- fs::dir_ls(path = "../../data/respiration/20230712/", glob = "*_20230712.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in 20230712.txt. * = wildcard
files20230712 #Confirm the list has the correct files
```

```{r}
dat20230712 <- read_delim(files20230712, id = "tank", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:4, 7:9, 10, 14)) #Import data using "tank" as an ID column for all files in the designated list. Specify tab-delimited files and skip the first 20 lines. There are no column names. Select data from probes 2-4.
colnames(dat20230712) <- c("tank", "date", "time", "dt_s", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(dat20230712) #Confirm import
```

```{r}
dat20230712 <- dat20230712 %>%
  mutate(., tank = str_sub(tank, 33, 37)) %>%
  mutate(., day = rep(14, times = nrow(dat20230712))) %>%
  mutate(., treatment = case_when(tank == "tank1" ~ "5C",
                                  tank == "tank2" ~ "15C",
                                  tank == "tank3" ~ "25C",
                                  tank == "tank4" ~ "5C",
                                  tank == "tank5" ~ "15C",
                                  tank == "tank6" ~ "25C",
                                  tank == "tank7" ~ "5C",
                                  tank == "tank8" ~ "15C",
                                  tank == "tank9" ~ "25C")) %>%
  mutate(., perc_air_sat_2 = as.numeric(perc_air_sat_2)) %>%
  mutate(., perc_air_sat_3 = as.numeric(perc_air_sat_3)) %>%
  mutate(., perc_air_sat_4 = as.numeric(perc_air_sat_4)) #Isolate tank ID from the file path. Add day and treatment information. Convert perc_air_sat columns to numeric
tail(dat20230712) #Confirm tank and treatment information
```

### 2023-07-19

```{r}
files20230719 <- fs::dir_ls(path = "../../data/respiration/20230719/", glob = "*_20230719.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in 20230719.txt. * = wildcard
files20230719 #Confirm the list has the correct files
```

```{r}
dat20230719 <- read_delim(files20230719, id = "tank", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:4, 7:9, 10, 14)) #Import data using "tank" as an ID column for all files in the designated list. Specify tab-delimited files and skip the first 20 lines. There are no column names. Select data from probes 2-4.
colnames(dat20230719) <- c("tank", "date", "time", "dt_s", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(dat20230719) #Confirm import
```

```{r}
dat20230719 <- dat20230719 %>%
  mutate(., tank = str_sub(tank, 33, 37)) %>%
  mutate(., day = rep(21, times = nrow(dat20230719))) %>%
  mutate(., treatment = case_when(tank == "tank1" ~ "5C",
                                  tank == "tank2" ~ "15C",
                                  tank == "tank3" ~ "25C",
                                  tank == "tank4" ~ "5C",
                                  tank == "tank5" ~ "15C",
                                  tank == "tank6" ~ "25C",
                                  tank == "tank7" ~ "5C",
                                  tank == "tank8" ~ "15C",
                                  tank == "tank9" ~ "25C")) %>%
  mutate(., perc_air_sat_2 = as.numeric(perc_air_sat_2)) %>%
  mutate(., perc_air_sat_3 = as.numeric(perc_air_sat_3)) %>%
  mutate(., perc_air_sat_4 = as.numeric(perc_air_sat_4)) #Isolate tank ID from the file path. Add day and treatment information. Convert perc_air_sat columns to numeric
tail(dat20230719) #Confirm tank and treatment information
```

### 2023-07-26

```{r}
files20230726 <- fs::dir_ls(path = "../../data/respiration/20230726/", glob = "*_20230726.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in 20230726.txt. * = wildcard
files20230726 #Confirm the list has the correct files
```

```{r}
dat20230726 <- read_delim(files20230726, id = "tank", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:4, 7:9, 10, 14)) #Import data using "tank" as an ID column for all files in the designated list. Specify tab-delimited files and skip the first 20 lines. There are no column names. Select data from probes 2-4.
colnames(dat20230726) <- c("tank", "date", "time", "dt_s", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(dat20230726) #Confirm import
```

```{r}
dat20230726 <- dat20230726 %>%
  mutate(., tank = str_sub(tank, 33, 37)) %>%
  mutate(., day = rep(28, times = nrow(dat20230726))) %>%
  mutate(., treatment = case_when(tank == "tank1" ~ "5C",
                                  tank == "tank2" ~ "15C",
                                  tank == "tank3" ~ "25C",
                                  tank == "tank4" ~ "5C",
                                  tank == "tank5" ~ "15C",
                                  tank == "tank6" ~ "25C",
                                  tank == "tank7" ~ "5C",
                                  tank == "tank8" ~ "15C",
                                  tank == "tank9" ~ "25C")) %>%
  mutate(., perc_air_sat_2 = as.numeric(perc_air_sat_2)) %>%
  mutate(., perc_air_sat_3 = as.numeric(perc_air_sat_3)) %>%
  mutate(., perc_air_sat_4 = as.numeric(perc_air_sat_4)) #Isolate tank ID from the file path. Add day and treatment information. Convert perc_air_sat columns to numeric
tail(dat20230726) #Confirm tank and treatment information
```

## 2023-08-09

```{r}
files20230809 <- fs::dir_ls(path = "../../data/respiration/20230809/", glob = "*_20230809.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in 20230809.txt. * = wildcard
files20230809 #Confirm the list has the correct files
```

```{r}
dat20230809 <- read_delim(files20230809, id = "tank", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:4, 7:9, 10, 14)) #Import data using "tank" as an ID column for all files in the designated list. Specify tab-delimited files and skip the first 20 lines. There are no column names. Select data from probes 2-4.
colnames(dat20230809) <- c("tank", "date", "time", "dt_s", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(dat20230809) #Confirm import
```

```{r}
dat20230809 <- dat20230809 %>%
  mutate(., tank = str_sub(tank, 33, 37)) %>%
  mutate(., day = rep(42, times = nrow(dat20230809))) %>%
  mutate(., treatment = case_when(tank == "tank1" ~ "5C",
                                  tank == "tank2" ~ "15C",
                                  tank == "tank3" ~ "25C",
                                  tank == "tank4" ~ "5C",
                                  tank == "tank5" ~ "15C",
                                  tank == "tank6" ~ "25C",
                                  tank == "tank7" ~ "5C",
                                  tank == "tank8" ~ "15C",
                                  tank == "tank9" ~ "25C")) %>%
  mutate(., perc_air_sat_2 = as.numeric(perc_air_sat_2)) %>%
  mutate(., perc_air_sat_3 = as.numeric(perc_air_sat_3)) %>%
  mutate(., perc_air_sat_4 = as.numeric(perc_air_sat_4)) #Isolate tank ID from the file path. Add day and treatment information. Convert perc_air_sat columns to numeric
tail(dat20230809) #Confirm tank and treatment information
```

## 2023-08-16

```{r}
files20230816 <- fs::dir_ls(path = "../../data/respiration/20230816/", glob = "*_20230816.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in 20230816.txt. * = wildcard
files20230816 #Confirm the list has the correct files
```

```{r}
dat20230816 <- read_delim(files20230816, id = "tank", skip = 20, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:4, 7:9, 10, 14)) #Import data using "tank" as an ID column for all files in the designated list. Specify tab-delimited files and skip the first 20 lines. There are no column names. Select data from probes 2-4.
colnames(dat20230816) <- c("tank", "date", "time", "dt_s", "perc_air_sat_2", "perc_air_sat_3", "perc_air_sat_4", "temp_C", "pressure_mbar") #Rename columns
tail(dat20230816) #Confirm import
```

```{r}
dat20230816 <- dat20230816 %>%
  mutate(., tank = str_sub(tank, 33, 37)) %>%
  mutate(., day = rep(49, times = nrow(dat20230816))) %>%
  mutate(., treatment = case_when(tank == "tank1" ~ "5C",
                                  tank == "tank4" ~ "5C",
                                  tank == "tank7" ~ "5C")) %>%
  mutate(., perc_air_sat_2 = as.numeric(perc_air_sat_2)) %>%
  mutate(., perc_air_sat_3 = as.numeric(perc_air_sat_3)) %>%
  mutate(., perc_air_sat_4 = as.numeric(perc_air_sat_4)) #Isolate tank ID from the file path. Add day and treatment information. Convert perc_air_sat columns to numeric
tail(dat20230816) #Confirm tank and treatment information
```

# Format data

I will create a datetime column and add salinity values. I'll also remove any extraneous columns that aren't needed for respirometry analysis and pivot the table longer.

## Salinity calculations

I need salinity values to format my data...however, I forgot to take salinity measurements for the first two weeks of the experiment. So, I'm going to average the salinity values from across the experiment to use for the first two weeks.

```{r}
salinityValues <- data.frame(day = c(7, 14, 21, 28, 42, 49),
                             tank1 = c(NA, NA, 36, 40, 36, 39),
                             tank2 = c(NA, NA, 35, 35, 35, NA),
                             tank3 = c(NA, NA, 32, 34, 33, NA),
                             tank4 = c(NA, NA, 36, 39, 36, 39),
                             tank5 = c(NA, NA, 35, 34, 35, NA),
                             tank6 = c(NA, NA, 32, 36, 33, NA),
                             tank7 = c(NA, NA, 37, 38, 36, 39),
                             tank8 = c(NA, NA, 35, 34, 35, NA),
                             tank9 = c(NA, NA, 32, 34, 32, NA)) %>% 
  column_to_rownames(., var = "day") %>%
  t(.) %>%
  as.data.frame() %>% 
  mutate(., "7" = rowMeans(., na.rm = TRUE)) %>%
  mutate(., "14" = rowMeans(., na.rm = TRUE)) #Create new dataframe with all salinity values recorded based on lab notebook posts. Use NA when no salinity values were recorded. Convert day column to rownames, then transpose. Use rowMeans to calculate average salinity values to use for the first two days of measurements for each tank.
head(salinityValues) #Confirm dataframe creation
```

## 2023-07-05

```{r}
colnames(dat20230705)
```

```{r}
dat20230705mod <- dat20230705 %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ as.numeric(salinityValues$`7`[1]),
                                 tank == "tank2" ~ as.numeric(salinityValues$`7`[2]),
                                 tank == "tank3" ~ as.numeric(salinityValues$`7`[3]),
                                 tank == "tank4" ~ as.numeric(salinityValues$`7`[4]),
                                 tank == "tank5" ~ as.numeric(salinityValues$`7`[5]),
                                 tank == "tank6" ~ as.numeric(salinityValues$`7`[6]),
                                 tank == "tank7" ~ as.numeric(salinityValues$`7`[7]),
                                 tank == "tank8" ~ as.numeric(salinityValues$`7`[8]),
                                 tank == "tank9" ~ as.numeric(salinityValues$`7`[9]))) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_2, perc_air_sat_3, perc_air_sat_4), names_to = "probe_num", values_to = "perc_air_sat") %>%
  mutate(., probe_num = gsub("perc_air_sat_", replacement = "", x = probe_num)) #Create a new datetime column for easy plotting. Add salinity information for all tanks from salinityValues. Arrange by treatment and tank. Pivot all air saturation columns, keeping the original column name as a new columm (probe_num). Remove text before numbers to get probe numbers.
head(dat20230705mod) #Confirm formatting
```

```{r}
dat20230705mod <- dat20230705mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
tail(dat20230705mod)
```

## 2023-07-12

```{r}
dat20230712mod <- dat20230712 %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ as.numeric(salinityValues$`14`[1]),
                                 tank == "tank2" ~ as.numeric(salinityValues$`14`[2]),
                                 tank == "tank3" ~ as.numeric(salinityValues$`14`[3]),
                                 tank == "tank4" ~ as.numeric(salinityValues$`14`[4]),
                                 tank == "tank5" ~ as.numeric(salinityValues$`14`[5]),
                                 tank == "tank6" ~ as.numeric(salinityValues$`14`[6]),
                                 tank == "tank7" ~ as.numeric(salinityValues$`14`[7]),
                                 tank == "tank8" ~ as.numeric(salinityValues$`14`[8]),
                                 tank == "tank9" ~ as.numeric(salinityValues$`14`[9]))) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_2, perc_air_sat_3, perc_air_sat_4), names_to = "probe_num", values_to = "perc_air_sat") %>%
  mutate(., probe_num = gsub("perc_air_sat_", replacement = "", x = probe_num)) #Create a new datetime column for easy plotting. Add salinity information for all tanks from salinityValues. Arrange by treatment and tank. Pivot all air saturation columns, keeping the original column name as a new columm (probe_num). Remove text before numbers to get probe numbers.
head(dat20230712mod) #Confirm formatting
```

```{r}
dat20230712mod <- dat20230712mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
tail(dat20230712mod)
```

## 2023-07-19

```{r}
dat20230719mod <- dat20230719 %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ as.numeric(salinityValues$`21`[1]),
                                 tank == "tank2" ~ as.numeric(salinityValues$`21`[2]),
                                 tank == "tank3" ~ as.numeric(salinityValues$`21`[3]),
                                 tank == "tank4" ~ as.numeric(salinityValues$`21`[4]),
                                 tank == "tank5" ~ as.numeric(salinityValues$`21`[5]),
                                 tank == "tank6" ~ as.numeric(salinityValues$`21`[6]),
                                 tank == "tank7" ~ as.numeric(salinityValues$`21`[7]),
                                 tank == "tank8" ~ as.numeric(salinityValues$`21`[8]),
                                 tank == "tank9" ~ as.numeric(salinityValues$`21`[9]))) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_2, perc_air_sat_3, perc_air_sat_4), names_to = "probe_num", values_to = "perc_air_sat") %>%
  mutate(., probe_num = gsub("perc_air_sat_", replacement = "", x = probe_num)) #Create a new datetime column for easy plotting. Add salinity information for all tanks from salinityValues. Arrange by treatment and tank. Pivot all air saturation columns, keeping the original column name as a new columm (probe_num). Remove text before numbers to get probe numbers.
head(dat20230719mod) #Confirm formatting
```

```{r}
dat20230719mod <- dat20230719mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
tail(dat20230719mod)
```

## 2023-07-26

```{r}
dat20230726mod <- dat20230726 %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ as.numeric(salinityValues$`28`[1]),
                                 tank == "tank2" ~ as.numeric(salinityValues$`28`[2]),
                                 tank == "tank3" ~ as.numeric(salinityValues$`28`[3]),
                                 tank == "tank4" ~ as.numeric(salinityValues$`28`[4]),
                                 tank == "tank5" ~ as.numeric(salinityValues$`28`[5]),
                                 tank == "tank6" ~ as.numeric(salinityValues$`28`[6]),
                                 tank == "tank7" ~ as.numeric(salinityValues$`28`[7]),
                                 tank == "tank8" ~ as.numeric(salinityValues$`28`[8]),
                                 tank == "tank9" ~ as.numeric(salinityValues$`28`[9]))) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_2, perc_air_sat_3, perc_air_sat_4), names_to = "probe_num", values_to = "perc_air_sat") %>%
  mutate(., probe_num = gsub("perc_air_sat_", replacement = "", x = probe_num)) #Create a new datetime column for easy plotting. Add salinity information for all tanks from salinityValues. Arrange by treatment and tank. Pivot all air saturation columns, keeping the original column name as a new columm (probe_num). Remove text before numbers to get probe numbers.
head(dat20230726mod) #Confirm formatting
```

```{r}
dat20230726mod <- dat20230726mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
tail(dat20230726mod)
```

## 2023-08-09

```{r}
dat20230809mod <- dat20230809 %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ as.numeric(salinityValues$`42`[1]),
                                 tank == "tank2" ~ as.numeric(salinityValues$`42`[2]),
                                 tank == "tank3" ~ as.numeric(salinityValues$`42`[3]),
                                 tank == "tank4" ~ as.numeric(salinityValues$`42`[4]),
                                 tank == "tank5" ~ as.numeric(salinityValues$`42`[5]),
                                 tank == "tank6" ~ as.numeric(salinityValues$`42`[6]),
                                 tank == "tank7" ~ as.numeric(salinityValues$`42`[7]),
                                 tank == "tank8" ~ as.numeric(salinityValues$`42`[8]),
                                 tank == "tank9" ~ as.numeric(salinityValues$`42`[9]))) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_2, perc_air_sat_3, perc_air_sat_4), names_to = "probe_num", values_to = "perc_air_sat") %>%
  mutate(., probe_num = gsub("perc_air_sat_", replacement = "", x = probe_num)) #Create a new datetime column for easy plotting. Add salinity information for all tanks from salinityValues. Arrange by treatment and tank. Pivot all air saturation columns, keeping the original column name as a new columm (probe_num). Remove text before numbers to get probe numbers.
head(dat20230809mod) #Confirm formatting
```

```{r}
dat20230809mod <- dat20230809mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
tail(dat20230809mod)
```

## 2023-08-16

```{r}
dat20230816mod <- dat20230816 %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ as.numeric(salinityValues$`42`[1]),
                                 tank == "tank4" ~ as.numeric(salinityValues$`42`[4]),
                                 tank == "tank7" ~ as.numeric(salinityValues$`42`[7]),
                                 tank == "tank8" ~ as.numeric(salinityValues$`42`[8]))) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_2, perc_air_sat_3, perc_air_sat_4), names_to = "probe_num", values_to = "perc_air_sat") %>%
  mutate(., probe_num = gsub("perc_air_sat_", replacement = "", x = probe_num)) #Create a new datetime column for easy plotting. Add salinity information for all tanks from salinityValues. Arrange by treatment and tank. Pivot all air saturation columns, keeping the original column name as a new columm (probe_num). Remove text before numbers to get probe numbers.
head(dat20230816mod) #Confirm formatting
```

```{r}
dat20230816mod <- dat20230816mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
tail(dat20230816mod)
```

# Initial figure

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Reds")[7],
                brewer.pal(9, "Greys")[7],
                brewer.pal(9, "Blues")[7]) #Create color scheme
```

## 2023-07-05

```{r}
dat20230705mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2023-07-05-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2023-07-12

```{r}
dat20230712mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2023-07-12-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2023-07-19

```{r}
dat20230719mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2023-07-19-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2023-07-26

```{r}
dat20230726mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2023-07-26-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2023-08-09

```{r}
dat20230809mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2023-08-09-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2023-08-16

```{r}
dat20230816mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

Ah yes, crab 5-068 disappeared between when we did TTR and respirometry so probe 4 is an empty chamber (sneaky, sneaky crabs). So, let's remove that data shall we?

```{r}
dat20230816mod <- dat20230816mod %>%
  filter(., tank != "tank4" | probe_num != "4") #Remove data from tank 4, probe 4
```

```{r}
dat20230816mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2023-08-16-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

# Clean data

## 2023-07-05

```{r}
dat20230705mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
```

There are a couple of anomalies that need to be removed. Also, looks like probe 2 on tanks 8 and 6 have recorded values < 80 before actual measurements start, which is why that data has disappeared I have empty (or almost empty) plots. I'll need to deal with those values BEFORE I remove the measurements after the "first" 80% air saturation hit.

```{r}
dat20230705mod %>%
  filter(., perc_air_sat <= 100) %>% 
  filter(., tank == "tank9") %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 99)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 99, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  #scale_x_continuous(limits = c(95, 100)) +
  # scale_y_continuous(breaks = seq(95, 100, 1), 
  #                     limits = c(95, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20230705clean <- dat20230705mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 82)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 168)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 65)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 114)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 218)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 151)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 140)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 5)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 208)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 71)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 155)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 14)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 97)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 130)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 375)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 170)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 77)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 1)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 41)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 185)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 356)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 90)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 99)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 65, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 114, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 218, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 151, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 140, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 5, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 208, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 71, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 155, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 14, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 97, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 82, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 77, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 375, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 41, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 185, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 168, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 356, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 99, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Remove values that reach 80 before actual recording starts. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Use filter statements to remove data from beginning of run where recording starts prior to setting up chambers. Use an ifelse statement within mutate to change dt_s for the tank/probe combination based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides three columns per treatment.
dat20230705clean
ggsave("figures/2023-07-05-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20230705cleanDOumol <- dat20230705mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 82)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 168)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 65)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 114)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 218)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 151)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 140)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 5)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 208)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 71)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 155)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 14)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 97)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 130)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 375)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 170)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 77)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 1)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 41)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 185)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 356)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 90)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 99)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 65, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 114, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 218, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 151, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 140, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 5, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 208, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 71, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 155, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 14, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 97, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 82, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 77, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 375, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 41, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 185, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 168, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 356, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 99, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Same figure but with DO values
dat20230705cleanDOumol
ggsave("figures/2023-07-05-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2023-07-12

Tanks 5, 1, and 4 need probe 2 to be filtered prior to removing values after hitting 80 the first time.

```{r}
dat20230712mod %>%
  filter(., perc_air_sat <= 100) %>% 
  filter(., tank == "tank9") %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 170)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 61)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 61, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  #scale_x_continuous(limits = c(170, 175)) +
  # scale_y_continuous(breaks = seq(80, 100, 1),
  #                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20230712clean <- dat20230712mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 78)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 314)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 221)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 124)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 173)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 54)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 241)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 218)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 241)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 575)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 162)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 240)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 36)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 99)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 126)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 178)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 87)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 42)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 170)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 61)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 78, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 124, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 173, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 54, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 241, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 218, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 241, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 314, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 575, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 221, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 162, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 240, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 36, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 99, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 126, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 178, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 87, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 61, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Remove values that reach 80 before actual recording starts. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Use filter statements to remove data from beginning of run where recording starts prior to setting up chambers. Use an ifelse statement within mutate to change dt_s for the tank/probe combination based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides three columns per treatment.
dat20230712clean
ggsave("figures/2023-07-12-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20230712cleanDOumol <- dat20230712mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 78)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 314)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 221)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 124)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 173)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 54)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 241)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 218)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 241)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 575)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 162)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 240)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 36)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 99)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 126)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 178)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 87)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 42)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 170)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 61)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 78, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 124, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 173, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 54, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 241, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 218, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 241, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 314, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 575, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 221, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 162, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 240, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 36, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 99, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 126, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 178, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 87, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 61, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Same figure but with DO values
dat20230712cleanDOumol
ggsave("figures/2023-07-12-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2023-07-19

Probe 2 for tanks 9, 1, and 4 have values that need to be removed first. Why is it always probe 2?!

```{r}
dat20230719mod %>%
  filter(., perc_air_sat <= 100) %>% 
  filter(., tank == "tank8") %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 63)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 142)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 214)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 63, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 142, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 214, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  #scale_x_continuous(limits = c(210, 215)) +
  # scale_y_continuous(breaks = seq(80, 100, 1),
  #                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20230719clean <- dat20230719mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 26)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 40)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 90)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 126)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 174)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 188)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 112)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 280)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 320)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 56)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 55)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 70)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 70)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 130)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 41)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 92)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 146)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 63)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 142)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 214)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 90)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 151)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 26, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 126, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 174, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 188, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 112, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 280, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 320, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 56, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 55, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 41, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 92, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 146, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 63, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 142, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 214, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 40, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 151, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Remove values that reach 80 before actual recording starts. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Use filter statements to remove data from beginning of run where recording starts prior to setting up chambers. Use an ifelse statement within mutate to change dt_s for the tank/probe combination based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides three columns per treatment.
dat20230719clean
ggsave("figures/2023-07-19-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20230719cleanDOumol <- dat20230719mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 26)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 40)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 90)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 126)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 174)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 188)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 112)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 280)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 320)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 56)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 55)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 70)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 70)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 130)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 41)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 92)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 146)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 63)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 142)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 214)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 90)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 151)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 26, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 126, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 174, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 188, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 112, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 280, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 320, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 56, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 55, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 41, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 92, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 146, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 63, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 142, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 214, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 40, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 151, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Same figure but with DO values
dat20230719cleanDOumol
ggsave("figures/2023-07-19-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2023-07-26

Tank 5 probe 4 and tank 7 probe 2 need to be cleaned first.

```{r}
dat20230726mod %>%
  filter(., perc_air_sat <= 100) %>% 
  filter(., tank == "tank9") %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 80)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 158)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 80, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 158, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  # scale_x_continuous(limits = c(155,160)) +
  scale_y_continuous(breaks = seq(80, 100, 10),
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20230726clean <- dat20230726mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 399)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 75)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 207)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 262)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 865)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 37)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 47)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 90)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 38)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 82)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 108)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 156)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 154)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 47)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 83)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 20)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 92)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 117)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 31)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 103)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 25)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 66)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 80)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 158)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 207, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 262, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 865, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 37, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 47, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 38, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 82, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 108, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 156, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 154, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 47, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 83, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 399, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 20, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 92, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 117, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 75, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 31, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 103, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 25, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 66, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 80, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 158, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Remove values that reach 80 before actual recording starts. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Use filter statements to remove data from beginning of run where recording starts prior to setting up chambers. Use an ifelse statement within mutate to change dt_s for the tank/probe combination based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides three columns per treatment.
dat20230726clean
ggsave("figures/2023-07-26-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20230726cleanDOumol <- dat20230726mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 399)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 75)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 207)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 262)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 865)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 37)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 47)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 90)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 38)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 82)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 108)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 156)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 154)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 47)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 83)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 20)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 92)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 117)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 31)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 103)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 25)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 66)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 80)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 158)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 207, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 262, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 865, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 37, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 47, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 38, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 82, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 108, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 156, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 154, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 47, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 83, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 399, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 20, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 92, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 117, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 75, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 31, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 103, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 25, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 66, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 80, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 158, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Same figure but with DO values
dat20230726cleanDOumol
ggsave("figures/2023-07-26-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2023-08-09

```{r}
dat20230809mod %>%
  filter(., perc_air_sat <= 100) %>% 
  filter(., tank == "tank7") %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 250)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 270)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 160)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 250, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 270, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 160, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  #scale_x_continuous(limits = c(125,150)) +
  scale_y_continuous(breaks = seq(80, 100, 10),
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20230809clean <- dat20230809mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 150)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 56)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 110)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 140)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 70)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 200)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 192)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 43)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 180)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 185)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 175)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 228)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 40)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 111)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 87)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 117)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 124)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 160)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 250)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 270)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 160)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 94)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 160)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 196)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 157)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 115)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 170)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 56, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 110, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 140, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 200, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 192, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 43, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 185, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 150, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 175, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 228, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 40, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 111, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 87, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 117, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 124, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 250, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 270, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 196, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 157, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 115, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 170, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Remove values that reach 80 before actual recording starts. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Use filter statements to remove data from beginning of run where recording starts prior to setting up chambers. Use an ifelse statement within mutate to change dt_s for the tank/probe combination based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides three columns per treatment.
dat20230809clean
ggsave("figures/2023-08-09-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20230809cleanDOumol <- dat20230809mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 150)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 56)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 110)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 140)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 70)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 200)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 192)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 43)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 180)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 185)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 175)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 228)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 40)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 111)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 87)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 117)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 124)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 160)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 250)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 270)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 160)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 94)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 160)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 196)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 157)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 115)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 170)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 56, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 110, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 140, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 200, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 192, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 43, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 185, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 150, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 175, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 228, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 40, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 111, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 87, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 117, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 124, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 250, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 270, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 196, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 157, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 115, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 170, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Same figure but with DO values
dat20230809cleanDOumol
ggsave("figures/2023-08-09-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2023-08-16

```{r}
dat20230816mod %>%
  filter(., perc_air_sat <= 100) %>% 
  filter(., tank == "tank7") %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 101)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 135)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 135, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  # scale_x_continuous(limits = c(115,120)) +
  scale_y_continuous(breaks = seq(80, 100, 10),
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20230816clean <- dat20230816mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 525)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 38)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 168)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 207)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 515)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 101)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 135)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 38, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 168, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 207, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 525, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 515, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 135, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Remove values that reach 80 before actual recording starts. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Use filter statements to remove data from beginning of run where recording starts prior to setting up chambers. Use an ifelse statement within mutate to change dt_s for the tank/probe combination based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides three columns per treatment.
dat20230816clean
ggsave("figures/2023-08-16-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20230816cleanDOumol <- dat20230816mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 525)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 38)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 168)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 207)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 515)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 101)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 135)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 38, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 168, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 207, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 525, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 515, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 135, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Same figure but with DO values
dat20230816cleanDOumol
ggsave("figures/2023-08-16-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

# Extract slopes

Now that I have my data cleaned, I need to get the regression slopes for each line I plotted.

## 2023-07-05

```{r}
dat20230705data <- dat20230705mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 82)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 168)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 65)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 114)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 218)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 151)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 140)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 5)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 208)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 71)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 155)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 14)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 97)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 130)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 375)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 170)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 77)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 1)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 41)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 185)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 356)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 90)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 1)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 99)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 65, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 114, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 218, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 151, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 140, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 5, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 208, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 71, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 155, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 14, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 97, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 82, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 77, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 375, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 41, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 185, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 168, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 356, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 1, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 99, dt_s)) #Save cleaned data as a new object
head(dat20230705data) #Confirm object creation
```

```{r}
dat20230705_MO2_slopes <- dat20230705data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230705_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20230705_MO2_glance <- dat20230705data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230705_MO2_glance #Confirm dataframe creation
```

```{r}
dat20230705_MO2_slope_results <- dat20230705_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230705_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230705_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20230705_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-05-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-07-12

```{r}
dat20230712data <- dat20230712mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 78)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 314)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 221)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 124)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 173)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 54)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 241)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 218)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 241)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 575)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 162)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 240)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 36)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 99)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 126)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 178)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 87)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 42)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 170)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 61)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 78, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 124, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 173, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 54, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 241, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 218, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 241, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 314, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 575, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 221, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 162, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 240, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 36, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 99, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 126, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 178, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 87, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 170, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 61, dt_s)) #Save cleaned data as a new object
head(dat20230712data) #Confirm object creation
```

```{r}
dat20230712_MO2_slopes <- dat20230712data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230712_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20230712_MO2_glance <- dat20230712data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230712_MO2_glance #Confirm dataframe creation
```

```{r}
dat20230712_MO2_slope_results <- dat20230712_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230712_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230712_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20230712_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-12-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour.
```

## 2023-07-19

```{r}
dat20230719data <- dat20230719mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 26)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 40)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 90)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 126)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 174)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 42)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 188)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 112)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 280)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 320)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 91)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 56)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 55)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 70)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 70)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 130)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 41)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 92)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 146)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 63)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 142)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 214)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 90)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 151)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 26, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 126, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 174, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 188, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 112, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 42, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 280, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 320, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 91, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 56, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 55, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 41, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 92, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 146, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 63, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 142, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 214, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 40, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 151, dt_s)) #Save cleaned data as a new object
head(dat20230719data) #Confirm object creation
```

```{r}
dat20230719_MO2_slopes <- dat20230719data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230719_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20230719_MO2_glance <- dat20230719data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230719_MO2_glance #Confirm dataframe creation
```

```{r}
dat20230719_MO2_slope_results <- dat20230719_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230719_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230719_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20230719_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-19-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour.
```

## 2023-07-26

```{r}
dat20230726data <- dat20230726mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 399)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 75)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 207)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 262)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 865)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 37)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 47)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 90)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 38)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 82)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 108)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 156)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 154)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 47)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 83)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 20)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 92)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 117)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 31)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 103)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 25)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 66)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 94)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 80)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 138)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 158)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 207, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 262, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 865, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 37, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 47, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 90, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 38, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 82, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 108, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 156, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 154, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 47, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 83, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 399, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 20, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 92, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 117, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 75, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 31, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 103, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 25, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 66, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 80, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 138, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 158, dt_s)) #Save cleaned data as a new object
head(dat20230726data) #Confirm object creation
```

```{r}
dat20230726_MO2_slopes <- dat20230726data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230726_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20230726_MO2_glance <- dat20230726data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230726_MO2_glance #Confirm dataframe creation
```

```{r}
dat20230726_MO2_slope_results <- dat20230726_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230726_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230726_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20230726_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-26-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-08-09

```{r}
dat20230809data <- dat20230809mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 150)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 56)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 110)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 140)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 70)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 200)) %>%
  filter(., !(tank == "tank2" & probe_num == 4 & dt_s < 192)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 43)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 180)) %>%
  filter(., !(tank == "tank3" & probe_num == 4 & dt_s < 185)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 175)) %>%
  filter(., !(tank == "tank4" & probe_num == 4 & dt_s < 228)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 40)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 111)) %>%
  filter(., !(tank == "tank5" & probe_num == 4 & dt_s < 87)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 117)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 124)) %>%
  filter(., !(tank == "tank6" & probe_num == 4 & dt_s < 160)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 250)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 270)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 160)) %>%
  filter(., !(tank == "tank8" & probe_num == 2 & dt_s < 94)) %>%
  filter(., !(tank == "tank8" & probe_num == 3 & dt_s < 160)) %>%
  filter(., !(tank == "tank8" & probe_num == 4 & dt_s < 196)) %>%
  filter(., !(tank == "tank9" & probe_num == 2 & dt_s < 157)) %>%
  filter(., !(tank == "tank9" & probe_num == 3 & dt_s < 115)) %>%
  filter(., !(tank == "tank9" & probe_num == 4 & dt_s < 170)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 56, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 110, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 140, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 70, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 200, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 4, dt_s - 192, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 43, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 4, dt_s - 185, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 150, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 175, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 4, dt_s - 228, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 40, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 111, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 4, dt_s - 87, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 117, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 124, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 4, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 250, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 270, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 2, dt_s - 94, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 3, dt_s - 160, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8" & probe_num == 4, dt_s - 196, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 2, dt_s - 157, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 3, dt_s - 115, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9" & probe_num == 4, dt_s - 170, dt_s)) #Save cleaned data as a new object
head(dat20230809data) #Confirm object creation
```

```{r}
dat20230809_MO2_slopes <- dat20230809data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230809_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20230809_MO2_glance <- dat20230809data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230809_MO2_glance #Confirm dataframe creation
```

```{r}
dat20230809_MO2_slope_results <- dat20230809_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230809_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230809_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20230809_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-08-09-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-08-16

```{r}
dat20230816data <- dat20230816mod %>%
  filter(., perc_air_sat <= 100) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 525)) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 38)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 168)) %>%
  filter(., !(tank == "tank1" & probe_num == 4 & dt_s < 207)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 515)) %>%
  filter(., !(tank == "tank7" & probe_num == 2 & dt_s < 101)) %>%
  filter(., !(tank == "tank7" & probe_num == 3 & dt_s < 120)) %>%
  filter(., !(tank == "tank7" & probe_num == 4 & dt_s < 135)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 38, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 168, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 4, dt_s - 207, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 525, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 515, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 2, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 3, dt_s - 120, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7" & probe_num == 4, dt_s - 135, dt_s)) #Save cleaned data as a new object
head(dat20230816data) #Confirm object creation
```

```{r}
dat20230816_MO2_slopes <- dat20230816data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230816_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20230816_MO2_glance <- dat20230816data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230816_MO2_glance #Confirm dataframe creation
```

```{r}
dat20230816_MO2_slope_results <- dat20230816_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230816_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230816_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20230816_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr)) + 
  geom_boxplot(color = plotColors[3]) + geom_point(size = 2, color = plotColors[3]) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  # scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
  #                    guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-08-16-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

# Blank-correct regression slopes

Next step: I need to extract data from the last 10-20 minutes of each chamber. This is my background respiration.

## 2023-07-05

```{r}
dat20230705mod %>%
  filter(., tank == "tank4") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_x_continuous(limits = c(5591, 6191)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20230705mod %>%
  filter(., !(tank == "tank1" & dt_s < 3900)) %>%
  filter(., !(tank == "tank2" & dt_s < 3480)) %>%
  filter(., !(tank == "tank3" & dt_s < 2360)) %>%
  filter(., !(tank == "tank4" & dt_s < 5591)) %>%
  filter(., !(tank == "tank5" & dt_s < 2649)) %>%
  filter(., !(tank == "tank6" & dt_s < 1236)) %>%
  filter(., !(tank == "tank7" & dt_s < 4895)) %>%
  filter(., !(tank == "tank8" & dt_s < 2347)) %>%
  filter(., !(tank == "tank9" & dt_s < 1325)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3900, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 3480, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2360, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 5591, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 2649, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1236, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 4895, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 2347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1325, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20230705blanks <- dat20230705mod %>%
  filter(., !(tank == "tank1" & dt_s < 3900)) %>%
  filter(., !(tank == "tank2" & dt_s < 3480)) %>%
  filter(., !(tank == "tank3" & dt_s < 2360)) %>%
  filter(., !(tank == "tank4" & dt_s < 5591)) %>%
  filter(., !(tank == "tank5" & dt_s < 2649)) %>%
  filter(., !(tank == "tank6" & dt_s < 1236)) %>%
  filter(., !(tank == "tank7" & dt_s < 4895)) %>%
  filter(., !(tank == "tank8" & dt_s < 2347)) %>%
  filter(., !(tank == "tank9" & dt_s < 1325)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3900, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 3480, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2360, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 5591, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 2649, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1236, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 4895, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 2347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1325, dt_s))
head(dat20230705blanks) #Confirm dataframe creation
```

```{r}
dat20230705_MO2_slopes_blanks <- dat20230705blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230705_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20230705_MO2_glance_blanks <- dat20230705blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230705_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20230705_MO2_slopes_blanks_results <- dat20230705_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230705_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230705_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20230705_MO2_all_slope_results <- dat20230705_MO2_slope_results %>%
  left_join(., dat20230705_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20230705_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20230705_MO2_all_slope_results
```

```{r}
write.csv(dat20230705_MO2_all_slope_results, "20230705-MO2-slope-results.csv", quote = FALSE, row.names = FALSE) #Save results with uncorrected, blank, and corrected slopes
```

```{r}
dat20230705_MO2_all_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-05-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-07-12

```{r}
dat20230712mod %>%
  filter(., tank == "tank9") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_x_continuous(limits = c(1311,1911)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20230712mod %>%
  filter(., !(tank == "tank1" & dt_s < 4728)) %>%
  filter(., !(tank == "tank2" & dt_s < 2329)) %>%
  filter(., !(tank == "tank3" & dt_s < 2206)) %>%
  filter(., !(tank == "tank4" & dt_s < 3775)) %>%
  filter(., !(tank == "tank5" & dt_s < 2544)) %>%
  filter(., !(tank == "tank6" & dt_s < 1372)) %>%
  filter(., !(tank == "tank7" & dt_s < 4846)) %>%
  filter(., !(tank == "tank8" & dt_s < 2857)) %>%
  filter(., !(tank == "tank9" & dt_s < 1311)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 4728, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 2329, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2206, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 3775, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 2544, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1372, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 4846, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 2857, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1311, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20230712blanks <- dat20230712mod %>%
  filter(., !(tank == "tank1" & dt_s < 4728)) %>%
  filter(., !(tank == "tank2" & dt_s < 2329)) %>%
  filter(., !(tank == "tank3" & dt_s < 2206)) %>%
  filter(., !(tank == "tank4" & dt_s < 3775)) %>%
  filter(., !(tank == "tank5" & dt_s < 2544)) %>%
  filter(., !(tank == "tank6" & dt_s < 1372)) %>%
  filter(., !(tank == "tank7" & dt_s < 4846)) %>%
  filter(., !(tank == "tank8" & dt_s < 2857)) %>%
  filter(., !(tank == "tank9" & dt_s < 1311)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 4728, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 2329, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2206, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 3775, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 2544, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1372, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 4846, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 2857, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1311, dt_s))
head(dat20230712blanks) #Confirm dataframe creation
```

```{r}
dat20230712_MO2_slopes_blanks <- dat20230712blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230712_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20230712_MO2_glance_blanks <- dat20230712blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230712_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20230712_MO2_slopes_blanks_results <- dat20230712_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230712_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230712_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20230712_MO2_all_slope_results <- dat20230712_MO2_slope_results %>%
  left_join(., dat20230712_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20230712_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20230712_MO2_all_slope_results
```

```{r}
write.csv(dat20230712_MO2_all_slope_results, "20220712-MO2-slope-results.csv", quote = FALSE, row.names = FALSE) #Save results with uncorrected, blank, and corrected slopes
```

```{r}
dat20230712_MO2_all_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-12-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-07-19

```{r}
dat20230719mod %>%
  filter(tank == "tank3") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  #scale_x_continuous(limits = c(1962,2562)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20230719mod %>%
  filter(., !(tank == "tank1" & dt_s < 4578)) %>%
  filter(., !(tank == "tank2" & dt_s < 2246)) %>%
  filter(., !(tank == "tank3" & dt_s < 1962)) %>%
  filter(., !(tank == "tank4" & dt_s < 4014)) %>%
  filter(., !(tank == "tank5" & dt_s < 1662)) %>%
  filter(., !(tank == "tank6" & dt_s < 1386)) %>%
  filter(., !(tank == "tank7" & dt_s < 3980)) %>%
  filter(., !(tank == "tank8" & dt_s < 2259)) %>%
  filter(., !(tank == "tank9" & dt_s < 1183)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 4578, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 2246, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 1962, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 4014, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 1662, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1386, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 3980, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 2259, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1183, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20230719blanks <- dat20230719mod %>%
  filter(., !(tank == "tank1" & dt_s < 4578)) %>%
  filter(., !(tank == "tank2" & dt_s < 2246)) %>%
  filter(., !(tank == "tank3" & dt_s < 1962)) %>%
  filter(., !(tank == "tank4" & dt_s < 4014)) %>%
  filter(., !(tank == "tank5" & dt_s < 1662)) %>%
  filter(., !(tank == "tank6" & dt_s < 1386)) %>%
  filter(., !(tank == "tank7" & dt_s < 3980)) %>%
  filter(., !(tank == "tank8" & dt_s < 2259)) %>%
  filter(., !(tank == "tank9" & dt_s < 1183)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 4578, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 2246, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 1962, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 4014, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 1662, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1386, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 3980, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 2259, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1183, dt_s))
head(dat20230719blanks) #Confirm dataframe creation
```

```{r}
dat20230719_MO2_slopes_blanks <- dat20230719blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230719_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20230719_MO2_glance_blanks <- dat20230719blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230719_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20230719_MO2_slopes_blanks_results <- dat20230719_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230719_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230719_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20230719_MO2_all_slope_results <- dat20230719_MO2_slope_results %>%
  left_join(., dat20230719_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20230719_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20230719_MO2_all_slope_results
```

```{r}
write.csv(dat20230719_MO2_all_slope_results, "20220719-MO2-slope-results.csv", quote = FALSE, row.names = FALSE) #Save results with uncorrected, blank, and corrected slopes
```

```{r}
dat20230719_MO2_all_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-19-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-07-26

```{r}
dat20230726mod %>%
  filter(., tank == "tank9") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_x_continuous(limits = c(1309, 1909)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20230726mod %>%
  filter(., !(tank == "tank1" & dt_s < 5400)) %>%
  filter(., !(tank == "tank1" & dt_s > 6000)) %>%
  filter(., !(tank == "tank2" & dt_s < 1699)) %>%
  filter(., !(tank == "tank3" & dt_s < 2361)) %>%
  filter(., !(tank == "tank4" & dt_s < 4156)) %>%
  filter(., !(tank == "tank5" & dt_s < 2593)) %>%
  filter(., !(tank == "tank6" & dt_s < 1325)) %>%
  filter(., !(tank == "tank7" & dt_s < 4027)) %>%
  filter(., !(tank == "tank8" & dt_s < 1689)) %>%
  filter(., !(tank == "tank9" & dt_s < 1309)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 5400, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 1699, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2361, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 4156, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 2593, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1325, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 4027, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 1689, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1309, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20230726blanks <- dat20230726mod %>%
  filter(., !(tank == "tank1" & dt_s < 5400)) %>%
  filter(., !(tank == "tank1" & dt_s > 6000)) %>%
  filter(., !(tank == "tank2" & dt_s < 1699)) %>%
  filter(., !(tank == "tank3" & dt_s < 2361)) %>%
  filter(., !(tank == "tank4" & dt_s < 4156)) %>%
  filter(., !(tank == "tank5" & dt_s < 2593)) %>%
  filter(., !(tank == "tank6" & dt_s < 1325)) %>%
  filter(., !(tank == "tank7" & dt_s < 4027)) %>%
  filter(., !(tank == "tank8" & dt_s < 1689)) %>%
  filter(., !(tank == "tank9" & dt_s < 1309)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 5400, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 1699, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2361, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 4156, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 2593, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1325, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 4027, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 1689, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1309, dt_s))
head(dat20230726blanks) #Confirm dataframe creation
```

```{r}
dat20230726_MO2_slopes_blanks <- dat20230726blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230726_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20230726_MO2_glance_blanks <- dat20230726blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230726_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20230726_MO2_slopes_blanks_results <- dat20230726_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230726_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230726_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20230726_MO2_all_slope_results <- dat20230726_MO2_slope_results %>%
  left_join(., dat20230726_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20230726_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20230726_MO2_all_slope_results
```

```{r}
write.csv(dat20230726_MO2_all_slope_results, "20220726-MO2-slope-results.csv", quote = FALSE, row.names = FALSE) #Save results with uncorrected, blank, and corrected slopes
```

```{r}
dat20230726_MO2_all_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-07-26-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-08-09

```{r}
dat20230809mod %>%
  filter(., tank == "tank9") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_x_continuous(limits = c(1300, 1900)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20230809mod %>%
  filter(., !(tank == "tank1" & dt_s < 3461)) %>%
  filter(., !(tank == "tank2" & dt_s < 1604)) %>%
  filter(., !(tank == "tank3" & dt_s < 2024)) %>%
  filter(., !(tank == "tank4" & dt_s < 4712)) %>%
  filter(., !(tank == "tank5" & dt_s < 1726)) %>%
  filter(., !(tank == "tank6" & dt_s < 1493)) %>%
  filter(., !(tank == "tank7" & dt_s < 2809)) %>%
  filter(., !(tank == "tank8" & dt_s < 1989)) %>%
  filter(., !(tank == "tank9" & dt_s < 1300)) %>%
  filter(., !(tank == "tank9" & dt_s > 1900)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3461, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 1604, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2024, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 4712, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 1726, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1493, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 2809, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 1989, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1300, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20230809blanks <- dat20230809mod %>%
  filter(., !(tank == "tank1" & dt_s < 3461)) %>%
  filter(., !(tank == "tank2" & dt_s < 1604)) %>%
  filter(., !(tank == "tank3" & dt_s < 2024)) %>%
  filter(., !(tank == "tank4" & dt_s < 4712)) %>%
  filter(., !(tank == "tank5" & dt_s < 1726)) %>%
  filter(., !(tank == "tank6" & dt_s < 1493)) %>%
  filter(., !(tank == "tank7" & dt_s < 2809)) %>%
  filter(., !(tank == "tank8" & dt_s < 1989)) %>%
  filter(., !(tank == "tank9" & dt_s < 1300)) %>%
  filter(., !(tank == "tank9" & dt_s > 1900)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3461, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 1604, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 2024, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 4712, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 1726, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1493, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 2809, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank8", dt_s - 1989, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank9", dt_s - 1300, dt_s))
head(dat20230809blanks) #Confirm dataframe creation
```

```{r}
dat20230809_MO2_slopes_blanks <- dat20230809blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230809_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20230809_MO2_glance_blanks <- dat20230809blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230809_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20230809_MO2_slopes_blanks_results <- dat20230809_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230809_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230809_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20230809_MO2_all_slope_results <- dat20230809_MO2_slope_results %>%
  left_join(., dat20230809_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20230809_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20230809_MO2_all_slope_results
```

```{r}
write.csv(dat20230809_MO2_all_slope_results, "20230809-MO2-slope-results.csv", quote = FALSE, row.names = FALSE) #Save results with uncorrected, blank, and corrected slopes
```

```{r}
dat20230809_MO2_all_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-08-09-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2023-08-16

```{r}
dat20230816mod %>%
  filter(., tank == "tank7") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_x_continuous(limits = c(6922, 7522)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20230816mod %>%
  filter(., !(tank == "tank1" & dt_s < 6286)) %>%
  filter(., !(tank == "tank4" & dt_s < 7095)) %>%
  filter(., !(tank == "tank7" & dt_s < 6922)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3461, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 7095, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 6922, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20230816blanks <- dat20230816mod %>%
  filter(., !(tank == "tank1" & dt_s < 6286)) %>%
  filter(., !(tank == "tank4" & dt_s < 7095)) %>%
  filter(., !(tank == "tank7" & dt_s < 6922)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3461, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 7095, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank7", dt_s - 6922, dt_s))
head(dat20230816blanks) #Confirm dataframe creation
```

```{r}
dat20230816_MO2_slopes_blanks <- dat20230816blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20230816_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20230816_MO2_glance_blanks <- dat20230816blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20230816_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20230816_MO2_slopes_blanks_results <- dat20230816_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20230816_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20230816_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20230816_MO2_all_slope_results <- dat20230816_MO2_slope_results %>%
  left_join(., dat20230816_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20230816_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20230816_MO2_all_slope_results
```

```{r}
write.csv(dat20230816_MO2_all_slope_results, "20230816-MO2-slope-results.csv", quote = FALSE, row.names = FALSE) #Save results with uncorrected, blank, and corrected slopes
```

```{r}
dat20230816_MO2_all_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected)) + 
  geom_boxplot(color = plotColors[3]) + geom_point(size = 2, color = plotColors[3]) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("15C", "25C", "5C"),
                   labels = c("15", "25", "5")) +
  scale_color_manual(guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2023-08-16-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

# Compare blank-corrected oxygen consumption across time and treatment

### Add demographic information

Sex and integument color can influence respiration rates. Even though all crabs were roughly the same size and weight for the chambers, there is still some variation that may explain differences in respiration rate. I will map this information to the slope results so I can incorporate it my statistical testing.

```{r}
crabMetadata <- read.csv("../../data/crab-metadata.csv", header = TRUE) %>%
  select(., c("ID", "treatment", "carapace.width", "carapace.length", "respirometry")) %>%
  dplyr::rename(crab.ID = "ID") #Import metadata. Select ID, treatment, width and length columns. Rename "ID" as "crab.ID"
head(crabMetadata) #Confirm changes
```

```{r}
demTTRdata <- read.csv("../../data/time-to-right.csv", header = TRUE) %>%
  dplyr::select(., -c(notes)) %>%
  dplyr::rename(., probe_num = probe.number) %>%
  filter(., is.na(probe_num) == FALSE) %>%
  mutate(., day = case_when(date == "7/5/23" ~ "07",
                            date == "7/12/23" ~ "14",
                            date == "7/19/23" ~ "21",
                            date == "7/26/23" ~ "28",
                            date == "8/9/23" ~ "42",
                            date == "8/16/23" ~ "49")) %>%
  filter(., is.na(day) == FALSE) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3)) %>%
  mutate(., treatment = case_when(tank == "T1" | tank == "T4" | tank == "T7" ~ "5C",
                                  tank == "T2" | tank == "T5" | tank == "T8" ~ "15C",
                                  tank == "T3" | tank == "T6" | tank == "T9" ~ "25C")) %>%
  left_join(., crabMetadata, by = c("crab.ID", "treatment")) %>%
  mutate(., missing.legs = case_when(number.legs < 10 ~ "Y",
                                     number.legs == 10 ~ "N")) %>%
  mutate(probe_num = case_when(probe_num == 1 ~ 4,
                               probe_num == 2 ~ 2,
                               probe_num == 3 ~ 3,
                               probe_num == 4 ~ 4)) %>%
  select(., c(crab.ID, day, treatment, tank, probe_num, sex, integument.cont, weight, carapace.width, missing.legs)) #Import TTR data and modify to include only the desired demographic data and average TTR data for crabs used during respiration trials
head(demTTRdata) #Confirm dataframe creation
```

```{r}
all_MO2_slope_results <- bind_rows("07" = dat20230705_MO2_all_slope_results,
                                   "14" = dat20230712_MO2_all_slope_results,
                                   "21" = dat20230719_MO2_all_slope_results,
                                   "28" = dat20230726_MO2_all_slope_results, 
                                   "42" = dat20230809_MO2_all_slope_results,
                                   "49" = dat20230816_MO2_all_slope_results,
                                   .id = "day") #Create a new dataframe with all corrected slope results, including a day
head(all_MO2_slope_results) #Confirm dataframe creation
```

```{r}
all_MO2_slope_results_demTTRdata <- all_MO2_slope_results %>%
  mutate(tank = case_when(tank == "tank1" ~ "T1",
                          tank == "tank2" ~ "T2",
                          tank == "tank3" ~ "T3",
                          tank == "tank4" ~ "T4",
                          tank == "tank5" ~ "T5",
                          tank == "tank6" ~ "T6",
                          tank == "tank7" ~ "T7",
                          tank == "tank8" ~ "T8",
                          tank == "tank9" ~ "T9")) %>%
  mutate(probe_num = as.numeric(probe_num)) %>%
  left_join(., demTTRdata, by = c("day", "treatment", "tank", "probe_num")) #Use case_when to include only the tank # in the tank column. Convert probe_num to a numeric column and left_join with demographic and TTR data using day, treatment, tank, and probe_num
head(all_MO2_slope_results_demTTRdata) #Confirm dataframe creation
```

### Add genotype information

```{r}
genotypeData <- read.csv("../../data/genotype/2023-crab-genotype.csv", header = TRUE, na.strings = "") %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  select(., crab.ID, treatment, final.genotype) #Import genotype data. Remove rows without final genotypes
head(genotypeData) #Confirm genotype dataframe creation
```

```{r}
all_MO2_slope_results_demTTRdata_genotype <- all_MO2_slope_results_demTTRdata %>%
  left_join(., genotypeData, by = c("crab.ID", "treatment")) %>%
  mutate(hasC = case_when(final.genotype == "CC" ~ "Y",
                          final.genotype == "CT" ~ "Y",
                          final.genotype == "TT" ~ "N"),
         hasT = case_when(final.genotype == "CC" ~ "N",
                          final.genotype == "CT" ~ "Y",
                          final.genotype == "TT" ~ "Y")) #Join dataframes by crab ID and treatment. Add two extra columns that are binaries for whether or not the genotype has a C or T using a series of case_when
head(all_MO2_slope_results_demTTRdata_genotype) #Confirm left_join and dataframe manipulation
```

### GLM

```{r}
hist(-(all_MO2_slope_results$slope_nmol_hr_corrected)) #Check distribution
hist(log(-(all_MO2_slope_results$slope_nmol_hr_corrected))) #Check log transformation
hist(sqrt(-(all_MO2_slope_results$slope_nmol_hr_corrected))) #Check log transformation
```

#### Full genotype 

```{r}
lmAllSlopeResults <- glm(log(-slope_nmol_hr_corrected) ~ treatment*as.numeric(day)*final.genotype + 
                           sex + weight + carapace.width + integument.cont + missing.legs, 
                         data = (all_MO2_slope_results_demTTRdata_genotype %>% filter(., blank_ratio < 0.10))) #Examine the influence of treatment, day, genotype, and various demographic factors on respiration rate. Remove outliers based on blank ratios prior to analysis.
summary(lmAllSlopeResults) #Significant impact of treatment and treatment:day on respiration
```

```{r}
lmAllSlopeResultsStep <- step(lmAllSlopeResults, direction = "backward") #Use backwards-deletion approach to identify the most significant model (lowest AIC)
summary(lmAllSlopeResultsStep) #The most significant model is one that includes treatment and day, but not the interaction between the two. None of the other demographic terms are significant
```

```{r}
lmAllSlopeResultsSig <- glm(log(-slope_nmol_hr_corrected) ~ treatment + as.numeric(day) + 
    final.genotype + sex + 
      treatment:as.numeric(day) + treatment:final.genotype + as.numeric(day):final.genotype + treatment:as.numeric(day):final.genotype, 
    data = (all_MO2_slope_results_demTTRdata_genotype %>% 
              filter(., blank_ratio < 0.1))) #Run the most significant model identified by step
summary(lmAllSlopeResultsSig) #Significant impact of treatment and treatment*day, and marginally significant impact of genotype
```

#### Binary genotype

Another way to incorporate genotype data is to use binary variables for whether or not the crab has at least one C or T allele. This assumes that having at least one allele would be enough to impact physiological response.

```{r}
lmBinarySlopeResults <- glm(log(-slope_nmol_hr_corrected) ~ treatment*as.numeric(day)*hasC + treatment*as.numeric(day)*hasT + 
                              sex + weight + carapace.width + integument.cont + missing.legs, 
                            data = (all_MO2_slope_results_demTTRdata_genotype %>% filter(., blank_ratio < 0.10))) #Examine the influence of treatment, day, and various demographic factors on respiration rate. Remove outliers based on blank ratios prior to analysis.
summary(lmBinarySlopeResults) #Significant impact of treatment, treatment:day, and hasT on respiration
```
```{r}
lmBinarySlopeResultsStep <- step(lmBinarySlopeResults, direction = "backward") #Use backwards-deletion approach to identify the most significant model (lowest AIC)
summary(lmBinarySlopeResultsStep) #The most significant model is one that includes treatment, day, the interaction, and hasT
```

```{r}
lmBinarySlopeResultsSig <- glm(log(-slope_nmol_hr_corrected) ~ treatment + as.numeric(day) + 
    hasC + hasT + sex + treatment:as.numeric(day) + treatment:hasC + 
    as.numeric(day):hasC + treatment:hasT + treatment:as.numeric(day):hasC, 
    data = (all_MO2_slope_results_demTTRdata_genotype %>% filter(., 
        blank_ratio < 0.1))) #Run the most significant model identified by step
summary(lmBinarySlopeResultsSig) #Significant impact of treatment, day, and treatment*day, and marginally significant impact of genotype
```
In this model, treatment is not significant, but there are several significant interactions. Also, presence of the C allele is significant, but presence of T is not. Time to try out a few more iterations.

```{r}
lmBinarySlopeResultsSigMinusTreat <- glm(log(-slope_nmol_hr_corrected) ~ as.numeric(day) + hasC + hasT + sex +
                                 as.numeric(day):hasC, 
                               data = (all_MO2_slope_results_demTTRdata_genotype %>% filter(., blank_ratio < 0.10))) #Same model, minus treatment
lmBinarySlopeResultsSigMinushasT <- glm(log(-slope_nmol_hr_corrected) ~ treatment + as.numeric(day) + hasC + sex +
                                 treatment:as.numeric(day) + treatment:hasC + as.numeric(day):hasC +
                                 treatment:as.numeric(day):hasC, 
                               data = (all_MO2_slope_results_demTTRdata_genotype %>% filter(., blank_ratio < 0.10))) #Same model, minus hasT
AIC(lmBinarySlopeResultsSig, lmBinarySlopeResultsSigMinusTreat, lmBinarySlopeResultsSigMinushasT) #Step model is still the most significant
```

#### Final model

I'll compare the two different models using AIC to determine which is a better fit.

```{r}
AIC(lmAllSlopeResultsSig, lmBinarySlopeResultsSig) #Compare AIC of both models. Model with binary genotype has lower AIC so that will be the final model
```

```{r}
write.csv(broom::tidy(lmBinarySlopeResultsSig), "all-slope-results-model-output.csv", quote = FALSE, row.names = FALSE)
```

### Check assumptions

```{r}
hist(residuals(lmBinarySlopeResultsSig)) #Residuals normally distributed

plot(fitted(lmBinarySlopeResultsSig), residuals(lmBinarySlopeResultsSig)) #Slight heteroskedasticity
abline(h = 0, lty = 2, col = "grey")
```

## Create multipanel figure for oxygen consumption

```{r}
all_MO2_slope_results_reorder <- all_MO2_slope_results_demTTRdata_genotype %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment == "15C" ~ "15C",
                                  treatment == "25C" ~ "25C"))
#Reorder temperature treatments for plotting by renaming 5C as 05C so it is the first alphanumerically
head(all_MO2_slope_results_reorder)
```

```{r}
facet_labels <- c("07" = "Day 7",
                  "14" = "Day 14",
                  "21" = "Day 21",
                  "28" = "Day 28",
                  "42" = "Day 42",
                  "49" = "Day 49") #Assign labels for facets
```

```{r}
all_MO2_slope_results_reorder %>%
  filter(., blank_ratio < 0.10) %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(aes(shape = treatment), size = 2) +
  xlab("") + ylab("Oxygen Consumption (nmol/hr)") +
  facet_wrap(. ~ day, ncol = 3, labeller = labeller (day = facet_labels)) +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("", "", "")) +
  scale_y_continuous(breaks = seq(0, 25000, 5000)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(axis.ticks.x = element_blank(),
                                        axis.title.x = element_blank(),
                                        strip.text.x = element_text(size = 15),
                                        strip.background = element_rect(colour = "white"))
ggsave("figures/multipanel-oxygen-consumption-corrected.pdf", height = 8.5, width = 11)
#Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Facet wrap and use the labeller to relabel facets. Add consistent color and shape scales.
```

```{r}
all_MO2_slope_results_reorder %>%
  filter(., blank_ratio < 0.10) %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  xlab("") + ylab("Oxygen Consumption (nmol/hr)") +
  facet_wrap(. ~ day, ncol = 3, labeller = labeller (day = facet_labels)) +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("", "", "")) +
  scale_y_continuous(breaks = seq(0, 25000, 5000)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(axis.ticks.x = element_blank(),
                                        axis.title.x = element_blank(),
                                        strip.text.x = element_text(size = 15),
                                        strip.background = element_rect(colour = "white"))
ggsave("figures/multipanel-oxygen-consumption-corrected-genotype.pdf", height = 8.5, width = 11)
#Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Facet wrap and use the labeller to relabel facets. Add consistent color and shape scales.
```

# Within-group variability

The 15ºC and 25ºC treatments have more variability than the 5ºC treatments. To quantify this, I will calculate the standard deviation and coefficient of variation for each treatment x day combination.

```{r}
all_MO2_slope_results_meanSDCV <- all_MO2_slope_results_reorder %>%
  group_by(., treatment, day) %>%
  mutate(., slope_nmol_hr_corrected_mean = mean(-slope_nmol_hr_corrected)) %>%
  mutate(., slope_nmol_hr_corrected_SD = sd(-slope_nmol_hr_corrected)) %>%
  mutate(., slope_nmol_hr_corrected_CV = (slope_nmol_hr_corrected_SD/slope_nmol_hr_corrected_mean) * 100) %>%
  ungroup(.) #Take all slope results and group by treatment and day. Calculate the mean, SD, and CV for each treatment x day combination. Ungroup data.
tail(all_MO2_slope_results_meanSDCV)
```

```{r}
write.csv(all_MO2_slope_results_meanSDCV, "all-slope-results-mean-SD-CV.csv", quote = FALSE, row.names = FALSE) #Save dataframe
```

```{r}
all_MO2_slope_results_meanSDCV %>%
  select(., treatment, day, slope_nmol_hr_corrected_SD) %>%
  ggplot(., aes(x = day, y = slope_nmol_hr_corrected_SD, group = treatment, color = treatment)) + 
  geom_line(aes(lty = treatment)) + geom_point(aes(shape = treatment), size = 2) +
  xlab("Day") + ylab("SD of Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("07", "14", "21", "28", "42", "49"),
                   labels = c(7, 14, 21, 28, 42, 49)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_linetype_manual(values = c(2, 1, 6),
                        name = "Temperature (ºC)",
                        breaks = c("05C", "15C", "25C"),
                        labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15)
ggsave("figures/multipanel-oxygen-consumption-corrected-SD.pdf", height = 8.5, width = 11)
#Create a line graph for the SD of oxygen consumption (nmol/hr) over experimental day. Define color, shape, and line type by treatment.
```

The line graph shows what was in the boxplot: variability for the 15ºC and 25ºC treatments are much higher, with the 25ºC having the highest variability at day 14.

```{r}
all_MO2_slope_results_meanSDCV %>%
  select(., treatment, day, slope_nmol_hr_corrected_CV) %>%
  ggplot(., aes(x = day, y = slope_nmol_hr_corrected_CV, group = treatment, color = treatment)) + 
  geom_line(aes(lty = treatment)) + geom_point(aes(shape = treatment), size = 2) +
  xlab("Day") + ylab("CV of Oxygen Consumption") +
  scale_x_discrete(breaks = c("07", "14", "21", "28", "42", "49"),
                   labels = c(7, 14, 21, 28, 42, 49)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_linetype_manual(values = c(2, 1, 6),
                        name = "Temperature (ºC)",
                        breaks = c("05C", "15C", "25C"),
                        labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15)
ggsave("figures/multipanel-oxygen-consumption-corrected-CV.pdf", height = 8.5, width = 11)
#Create a line graph for the CV of oxygen consumption over experimental day. Define color, shape, and line type by treatment.
```

The CV is a ratio between SD and the mean. It's interesting that CV for all three treatments is closest on days 14 and 28, and that the 15ºC has a much higher CV than the 25ºC treatment at day 21. Also, CV for the 5ºC is highest on day 49, which is the first day there's an outlier in the 5ºC treatment. These patterns seem to be more influenced by potential outliers.

# Pairwise Q10 calculations

Q10 is a metric used to quantify temperature sensitivity, generally defined as the change in a physiological response over a 10 degree temperature interval. For most organisms, Q10 is around 2 (a two-fold change in a physiological or chemical response due to a 10 degree temperature change). While most studies calculate Q10 metrics for individuals, Glandon et al. (2019) calculates treatment-level Q10 metrics to compare oxygen consumption data from their study exposing juvenile blue crabs to combined temperature x pCO<sub>2</sub> treatments with other decapod crustacean oxygen consumption literature:

Q10 = (R2/R1)^(10/(T2-T1))

where T1 = temperature 1, T2 = temperature 2, R1 = respiration at T1, and R2 = respiration at T2.

I am going to calculate pairwise Q10 metrics for each day with oxygen consumption data for all three treatments. This will provide another metric to compare across treatment x day combinations.

```{r}
all_MO2_slope_results_Q10output <- all_MO2_slope_results_meanSDCV %>%
  filter(., day != "49") %>%
  select(day, treatment, slope_nmol_hr_corrected_mean) %>%
  unique(.) %>%
  mutate(temperature = case_when(treatment == "15C" ~ 15,
                                 treatment == "25C" ~ 25,
                                 treatment == "05C" ~ 5)) %>% 
  pivot_wider(., names_from = treatment, values_from = c(slope_nmol_hr_corrected_mean, temperature)) %>%
  mutate(., Q10_15_25 = Q10(R1 = slope_nmol_hr_corrected_mean_15C, R2 = slope_nmol_hr_corrected_mean_25C, T1 = temperature_15C, T2 = temperature_25C)) %>%
  mutate(., Q10_15_5 = Q10(R1 = slope_nmol_hr_corrected_mean_05C, R2 = slope_nmol_hr_corrected_mean_15C, T1 = temperature_05C, T2 = temperature_15C)) %>%
  mutate(., Q10_25_5 = Q10(R1 = slope_nmol_hr_corrected_mean_05C, R2 = slope_nmol_hr_corrected_mean_25C, T1 = temperature_05C, T2 = temperature_25C)) %>%
  select(., -c(temperature_15C, temperature_25C, temperature_05C)) #Take input dataframe and pivot wider. Use treatment as IDs for new colums, and paste values from mean slope and tmeperature. Use the formula to calculate Q10 for each pairwise temperature comparison. Remove temperature columns.
all_MO2_slope_results_Q10output #Confirm Q10 calculations
```

When Q10 ~ 1, it means that respiration is temperature-independent. As Q10 increases, a process becomes more temperature dependent. Most biological processes have Q10 ~ 2, but processes with large-scale protein conformational changes can have larger Q10 values. Based on this information, it seems like transitioning to a warmer temperature is less temperature dependent, or requires less physiological remodeling, than transitioning to a colder temperature.

```{r}
write.csv(all_MO2_slope_results_Q10output, "mean-slope-pairwise-Q10.csv", quote = FALSE, row.names = FALSE) #Save dataframe
```

I'm going to plot Q10 values for the 13ºC vs. 5ºC or 30ºC comparisons.

```{r}
all_MO2_slope_results_Q10output %>%
  pivot_longer(., cols = starts_with("Q10_"), names_to = "comparison", values_to = "Q10") %>%
  select(., day, comparison, Q10) %>%
  filter(., comparison != "Q10_25_5") %>%
  ggplot(., aes(x = day, y = Q10, group = comparison)) +
  geom_line(aes(color = comparison, lty = comparison)) + geom_point(aes(color = comparison, shape = comparison), size = 2) +
  geom_line(y = 2, color = "black", lty = 5) +
  xlab("Day") + ylab("Pairwise Q10") +
  scale_y_continuous(lim = c(0,6.5), 
                     breaks = seq(0,6.5,2)) +
  scale_x_discrete(breaks = c("07", "14", "21", "28", "42"),
                   labels = c(7, 14, 21, 28, 42)) +
  scale_color_manual(values = c(plotColors[3], plotColors[1]), 
                     name = "Comparison",
                     breaks = c("Q10_15_5", "Q10_15_25"),
                     labels = c("15ºC vs. 5ºC", "15ºC vs. 25ºC")) +
  scale_linetype_manual(values = c(2, 6),
                        name = "Comparison",
                        breaks = c("Q10_15_5", "Q10_15_25"),
                        labels = c("15ºC vs. 5ºC", "15ºC vs. 25ºC")) +
  scale_shape_manual(values = c(15, 17),
                     name = "Comparison",
                     breaks = c("Q10_15_5", "Q10_15_25"),
                     labels = c("15ºC vs. 5ºC", "15ºC vs. 25ºC")) +
  theme_classic(base_size = 15)
ggsave("figures/pairwise-Q10.pdf", height = 8.5, width = 11)
#Create a line graph with pairwise Q10 metrics for control 15ºC vs. either the 5ºC or 25ºC treatments. First, pivot_longer the Q10 calculation table and select columns such that only day, Q10, and comparison information remains. Remove the 25ºC vs. 5ºC Q10 calculations. Plot the data, grouping by Q10 comparison. Assign colors, line type, and shape by comparison. 
```

# Individual-level variation

## Exploratory plots

```{r}
all_MO2_slope_results_reorder <- all_MO2_slope_results_reorder %>%
  group_by(., day, treatment, tank) %>%
  mutate(., slope_nmol_hr_corrected_avg = mean(slope_nmol_hr_corrected)) #Calculate tank average by day
head(all_MO2_slope_results_reorder) #Confirm calculations
```

```{r}
all_MO2_slope_results_reorder %>%
  filter(., blank_ratio < 0.10) %>%
  ggplot(., mapping = aes(x = as.numeric(day), y = (-slope_nmol_hr_corrected_avg + slope_nmol_hr_corrected), group = crab.ID, color = treatment, shape = treatment)) +
  geom_point(size = 1, alpha = 0.75) + geom_line(linetype = 3) +
  facet_wrap(vars(tank, treatment), ncol = 3) +
  scale_x_continuous(name = "Day",
                     breaks = c(seq(0, 42, 14), 49),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Difference from Average Oxygen Consumption (nmol/hr)") +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(strip.text.x = element_blank(),
                                        strip.background = element_blank()) #Plot difference from average oxygen consumption for each individual crab that was tracked over the entire experiment. Facet by tank and treatment so it's easier to visualize. Assign colors to each treatment and shapes to genotype.
ggsave("figures/multipanel-oxygen-consumption-individual.pdf", height = 8.5, width = 11)
```

```{r}
all_MO2_slope_results_reorder %>%
  filter(., blank_ratio < 0.10) %>%
  ggplot(., mapping = aes(x = as.numeric(day), y = (-slope_nmol_hr_corrected_avg + slope_nmol_hr_corrected), group = crab.ID, color = treatment, shape = final.genotype)) +
  geom_point(size = 1, alpha = 0.75) + geom_line(linetype = 3) +
  facet_wrap(vars(tank, treatment), ncol = 3) +
  scale_x_continuous(name = "Day",
                     breaks = c(seq(0, 42, 14), 49),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Difference from Average Oxygen Consumption (nmol/hr)") +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(strip.text.x = element_blank(),
                                        strip.background = element_blank()) #Plot difference from average oxygen consumption for each individual crab that was tracked over the entire experiment. Facet by tank and treatment so it's easier to visualize. Assign colors to each treatment and shapes to genotype.
ggsave("figures/multipanel-oxygen-consumption-individual-genotype.pdf", height = 8.5, width = 11)
```

From these plots, it's clear that there is less variation in the 5ºC treatment than the 25ºC treatment because some crabs vary more than others. Can genotype explain these differenes?

## Difference in respiration by genotype

look at the effects of genotype on the difference in TTR between days 2 and 7, days 2 and 21, and days 2 and 42. Although the 5ºC treatment was run for 49 days, since we know time has a significant influence on TTR I'm going to use the same time point for all variables. Looking at differences with day 7 can represent short-term differences, while days 21 and 42 would be longer-term differences. Day 21 is also a nice parallel to the three-week experiment run in 2022. I also have day 0 data for some of the crabs.

```{r}
all_MO2_slope_results_reorder
```

```{r}
all_MO2_slope_results_diff <- all_MO2_slope_results_reorder %>%
  ungroup(.) %>%
  arrange(., treatment) %>%
  select(., day, crab.ID, slope_nmol_hr_corrected, treatment, final.genotype) %>%
  filter(., day != "49") %>%
  mutate(hasC = case_when(final.genotype == "CC" ~ "Y",
                          final.genotype == "CT" ~ "Y",
                          final.genotype == "TT" ~ "N"),
         hasT = case_when(final.genotype == "CC" ~ "N",
                          final.genotype == "CT" ~ "Y",
                          final.genotype == "TT" ~ "Y")) %>%
  pivot_wider(., names_from = day, values_from = slope_nmol_hr_corrected, names_prefix = "day") %>%
  mutate(., day14v7 = -day14 + day07) %>%
  mutate(., day21v7 = -day21 + day07) %>%
  mutate(., day28v7 = -day28 + day07) %>%
  mutate(., day42v7 = -day42 + day07) #Select day, crab ID, slope, treatmet, and genotype information. Filter days of interest. Add binary genotype information. Pivot wider, using days as columns and values from slope and add "day" as a prefix to all columns. Get the difference in negative slope for comparisons of interest.
head(all_MO2_slope_results_diff)
```

#### Plot

```{r}
all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day14v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Oxygen Consumption (nmol/hr)", title = "Day 14 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/oxygen-consumption-individuals-genotype-day14v7.pdf", height = 8.5, width = 11)
```

```{r}
all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day21v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Oxygen Consumption (nmol/hr)", title = "Day 21 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/oxygen-consumption-individuals-genotype-day21v7.pdf", height = 8.5, width = 11)
```

```{r}
all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day28v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Oxygen Consumption (nmol/hr)", title = "Day 28 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/oxygen-consumption-individuals-genotype-day28v7.pdf", height = 8.5, width = 11)
```

```{r}
all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day42v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Oxygen Consumption (nmol/hr)", title = "Day 42 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/oxygen-consumption-individuals-genotype-day42v7.pdf", height = 8.5, width = 11)
```

```{r}
day14v7Plot <- all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day14v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "", y = "", title = "A. Day 14 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19, 17),
                     guide = "none") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(),
                                        axis.ticks.x = element_blank())
day14v7Plot
```

```{r}
day21v7Plot <- all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day21v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "", y = "", title = "B. Day 21 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19, 17),
                     guide = "none") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(),
                                        axis.ticks.x = element_blank())
day21v7Plot
```

```{r}
day42v7Plot <- all_MO2_slope_results_diff %>%
  filter(., is.na(final.genotype) == FALSE) %>%
  ggplot(mapping = aes(x = treatment, y = day42v7, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "", title = "C. Day 42 vs. Day 7") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19, 17),
                     guide = "none") +
  theme_classic(base_size = 15)
day42v7Plot
```

```{r}
#pdf("figures/oxygen-consumption-individuals-genotype-multiday-multipanel.pdf", height = 11, width = 8.5)

day14v7Plot / day21v7Plot / day42v7Plot
grid::grid.draw(grid::textGrob("Difference in Oxygen Consumption (nmol/hr)", x = 0.02, rot = 90, gp = gpar(fontsize = 15)))

#dev.off()
```
