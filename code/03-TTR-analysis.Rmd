---
title: "03-TTR-analysis"
author: "Yaamini Venkataraman"
date: '2023-10-16'
output: html_document
---

In this document I'll examine how time-to-right (TTR) varies by temperature and time.

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/03-TTR-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, include=FALSE}
#install.packages("tidyverse")
#install.packages("plotrix")
#install.packages("RColorBrewer")
#install.packages(lme4)
#install.packages("ggpubr")
#install.packages("patchwork")
#install.packages("respirometry")
require(tidyverse)
require(plotrix)
require(RColorBrewer)
require(lme4)
require(ggpubr)
require(patchwork)
require(respirometry)
```

```{r}
sessionInfo()
```

# Import data

```{r}
rawTTR <- read.csv("../../data/time-to-right.csv", header = TRUE) #Import raw data
head(rawTTR) #Confirm import. Trial data is in seconds.
```

```{r}
crabMetadata <- read.csv("../../data/crab-metadata.csv", header = TRUE) %>%
  select(., c("ID", "treatment", "carapace.width", "carapace.length", "respirometry")) %>%
  dplyr::rename(crab.ID = "ID") #Import metadata. Select ID, treatment, width and length columns. Rename "ID" as "crab.ID"
head(crabMetadata) #Confirm changes
```

```{r}
genotypeData <- read.csv("../../data/genotype/2023-crab-genotype.csv", header = TRUE, na.strings = "") %>%
  select(., crab.ID, treatment, final.genotype) #Import genotype data. Remove rows without final genotypes
head(genotypeData) #Confirm genotype dataframe creation
```

# Format data

FIX NAS BY GOING THROUGH AND FIXING MISLABELLED CRABS IN TTR DATA.

```{r}
modTTR <- rawTTR %>%
  dplyr::select(., -c(notes, probe.number)) %>%
  left_join(., crabMetadata, by = "crab.ID") %>%
  mutate(., day = case_when(date == "6/28/23" ~ 0,
                            date == "6/29/23" ~ 1,
                            date == "7/3/23" ~ 2,
                            date == "7/5/23" ~ 7,
                            date == "7/10/23" ~ 12, 
                            date == "7/12/23" ~ 14,
                            date == "7/17/23" ~ 19,
                            date == "7/19/23" ~ 21,
                            date == "7/24/23" ~ 26,
                            date == "7/26/23" ~ 28,
                            date == "8/9/23" ~ 42,
                            date == "8/16/23" ~ 49)) %>%
  mutate(., size = carapace.width/carapace.length) %>%
  filter(., is.na(size) == FALSE) %>% #Remove this line when TTR data is fixed
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  filter(., is.na(TTRSE) == FALSE) %>%
  group_by(., day, treatment) %>%
  mutate(., TTRavgFull = mean(TTRavg)) %>%
  mutate(., TTRSEFull = std.error(TTRavg)) %>%
  mutate(., TTRavgFullLow = TTRavgFull - TTRSEFull) %>%
  mutate(., TTRavgFullHigh = TTRavgFull + TTRSEFull) %>%
  ungroup(.) %>% 
  left_join(., genotypeData, by = c("crab.ID", "treatment")) #Remove sampling ID and notes columns. Add new column with day information. Create a a new column that with an index for width/length. Create new column as a binary for whether or not crabs are missing legs. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations, and remove rows where TTRavg | TTRSE = NA. Calculate average and SE for all samples in a treatment for each day. Add/subtract TTRSEFull to/from TTRavgFull to get bounds. Ungroup. Join with genotype data.
head(modTTR) #Confirm formatting
```

# Data exploration

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Reds")[7],
                brewer.pal(9, "Greys")[7],
                brewer.pal(9, "Blues")[7]) #Create color scheme
```

## Treatment

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = treatment)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) #Plot average TTR and add lm fits without SE bars. Modify x-axis to only show experimental days where TTR was measured. Scale y axis to include 91 = indication that crabs did not right within 90 s. Assign colors to each treatment. Increase base font size.
ggsave("figures/time-to-right-raw.pdf", height = 8.5, width = 11)
```

I'm now going to make plots for various other factors to see if any of these need to be taken into consideration!

## Sex

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex.pdf", height = 8.5, width = 11)
```

## Tank

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = as.factor(tank), shape = as.factor(tank))) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  scale_color_manual(values = rep(c(plotColors[3], plotColors[2], plotColors[1]), times = 3),
                     name = "Tank",
                     breaks = c("T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9")) +
  scale_shape_manual(values = c(19, 19, 19, 17, 17, 17, 15, 15, 15),
                     name = "Tank",
                     breaks = c("T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-tank.pdf", height = 8.5, width = 11)
```

## Integument color

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument.pdf", height = 8.5, width = 11)
```

## Number of Legs

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = as.factor(number.legs))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-numlegs.pdf", height = 8.5, width = 11)
```

## Weight

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight.pdf", height = 8.5, width = 11)
```

## Size (Width/Length)

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = size)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-size.pdf", height = 8.5, width = 11)
```

## Carapace width

```{r}
modTTR %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth.pdf", height = 8.5, width = 11)
```

## Genotype

```{r}
modTTR %>%
  filter(., is.na(final.genotype) == FALSE) %>% 
  ggplot(., mapping = aes(x = day, y = TTRavg, color = final.genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(4, 22)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 50, 10),
                     limits = c(0, 50)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype.pdf", height = 8.5, width = 11)
```

# Assess differences by treatment

I will use an ANOVA to assess treatment differences, as a linear model or ANOVA seems to be common practice in the literature (ex. [Blakeslee et al. 2021](https://doi.org/10.1098/rspb.2021.0703)).

```{r}
hist(modTTR$TTRavg)
hist(x = log(modTTR$TTRavg)) #Log transformation helps normalize data
```

## Mixed effects model

```{r}
TTRmodel <- lmer(log(TTRavg) ~ treatment + day + treatment:day + 
                   as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                   (1|crab.ID), 
                 data = modTTR, REML = FALSE) #Run model with treatment, timepoint, their interaction, sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later. Use data without rows with NAs
summary(TTRmodel) #Look at model output.
#Residuals explain more random effect variation than crab ID, crab ID explains very little variation
```
Now that I've run the full model, I want to test the importance of treatment, day, and their interaction as predictors. I'll include all other factors in the null model to account for any variation they may contribute.

```{r}
TTRnullTreatment <- lmer(log(TTRavg) ~ day + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTR, REML = FALSE) #Run null model without treatment to identify significance of predictor
anova(TTRnullTreatment, TTRmodel) #Treatment is a significant predictor
```

```{r}
TTRnullDay <- lmer(log(TTRavg) ~ treatment + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTR, REML = FALSE) #Run null model without day to identify significance of predictor
anova(TTRnullTreatment, TTRmodel) #Day is a significant predictor
```

```{r}
TTRnullInteraction <- lmer(log(TTRavg) ~ treatment + day + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTR, REML = FALSE) #Run model without interaction to identify significance of predictor. The full model constructed does not include an interaction
anova(TTRnullInteraction, TTRmodel) #Interaction is a significant predictor
```

```{r}
TTRModelComparisons<- rbind(broom::tidy(anova(TTRnullTreatment, TTRmodel)),
                            broom::tidy(anova(TTRnullDay, TTRmodel)),
                            broom::tidy(anova(TTRnullInteraction, TTRmodel))) #Create table for model comparison output
TTRModelComparisons
```

```{r}
write.csv(TTRModelComparisons, "ttr-model-comparison-stat-output.csv", quote = FALSE, row.names = FALSE) #Save model output
```

## Check assumptions

```{r}
hist(residuals(TTRmodel)) #Residuals normally distributed

plot(fitted(TTRmodel), residuals(TTRmodelSig)) #Borderline heteroskedastic but probably okay? Lack of dispersion across x-axis is likely related to discrete variables
abline(h = 0, lty = 2, col = "grey")
```

# Threshold analysis

Another way to analyze this data is to count how many crabs within each treatment righted within a certain threshold. I can identify this threshold by taking the upper bound of a boxplot, then using a binomial model similar to [Coyle et al. (2019)](https://doi.org/10.1242/jeb.203521).

## Define threshold

```{r}
boxplot.stats(modTTR$TTRavg)$stats[5] #Use Tukey's method to identify upper bound of outliers
```

```{r}
modTTR <- modTTR %>%
  mutate(., TTRthresh = case_when(TTRavg > boxplot.stats(modTTR$TTRavg)$stats[5] ~ 0,
                                  TTRavg <= boxplot.stats(modTTR$TTRavg)$stats[5] ~ 1)) #Create a new column where 1 = righted within the upper bound of the boxplot, 0 = failure to right within that threshold
head(modTTR) #Confirm changes
```

## Binomial model

```{r}
TTRthreshModel <- glm(I(TTRthresh == 1) ~ treatment + day + treatment*day + as.factor(sex) + as.factor(integument.color) + size + weight + as.factor(missing.swimmer), 
                      family = binomial(), 
                      data = modTTR) #Create a binomial model, where 1 = success of righting wihtin the defined threshold
summary(TTRthreshModel) #Only weight is significant
```

```{r}
step(TTRthreshModel, test = "LRT") #Use likelihood ratio tests and backwards deletion approaches to identify the best model
```

```{r}
TTRthreshModel2 <- glm(formula = I(TTRthresh == 1) ~ treatment + day + as.factor(integument.color) + 
                         weight + treatment:day, family = binomial(), data = modTTR) #Run model selected by step with only significant terms
summary(TTRthreshModel2) #Only weight significant
```

```{r}
write.csv(broom::tidy(TTRthreshModel2), "TTR-binomialModel.csv", quote = FALSE, row.names = FALSE) #Save binomal GLM output
```

# Final plots

```{r}
modTTR %>%
  dplyr::select(., c(day, treatment, TTRavgFull, TTRavgFullLow, TTRavgFullHigh)) %>%
  distinct(.) %>%
  ggplot(., mapping = aes(x = day, y = TTRavgFull, color = treatment, shape = treatment)) +
  geom_pointrange(aes(ymin = TTRavgFullLow,
                      ymax = TTRavgFullHigh), 
                  size = 0.5, alpha = 0.75) +
  geom_line(y = boxplot.stats(modTTR$TTRavg)$stats[5], lty = 2, color = "black") +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = c(0, seq(1, 5, 2), seq(5, 10, 5)),
                     limits = c(0, 10)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  scale_shape_manual(values = c(19, 17, 15),
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 15) #Plot average TTR and add lm fits without SE bars. Add vertical line for boxplot outlier threshold. Modify x-axis to only show experimental days where TTR was measured. Scale y axis to include 91 = indication that crabs did not right within 90 s. Assign colors to each treatment. Increase base font size.
ggsave("figures/time-to-right-avg.pdf", height = 8.5, width = 11)
```

```{r}
modTTR %>%
  dplyr::select(., c(day, treatment, TTRavgFull, TTRavgFullLow, TTRavgFullHigh)) %>%
  distinct(.) %>%
  ggplot(., mapping = aes(x = day, y = TTRavgFull, color = treatment, shape = treatment)) +
  geom_pointrange(aes(ymin = TTRavgFullLow,
                      ymax = TTRavgFullHigh), 
                  size = 0.5, alpha = 0.75) +
  scale_x_continuous(name = "Day",
                     breaks = unique(modTTR$day),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = c(0, seq(1, 5, 2), seq(5, 10, 5)),
                     limits = c(0, 10)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  scale_shape_manual(values = c(19, 17, 15),
                     name = "Temperature (ºC)",
                     breaks = c("15C", "25C", "5C"),
                     labels = c("15", "25", "5")) +
  theme_classic(base_size = 20) #Plot average TTR and add lm fits without SE bars. Add vertical line for boxplot outlier threshold. Modify x-axis to only show experimental days where TTR was measured. Scale y axis to include 91 = indication that crabs did not right within 90 s. Assign colors to each treatment. Increase base font size.
ggsave("figures/time-to-right-avg-nothresh.pdf", height = 8.5, width = 11)
```

```{r}
modTTR %>%
  dplyr::select(., c(day, treatment, TTRavg)) %>%
  distinct(.) %>%
  mutate(., day = case_when(day == 1 ~ "01",
                            day == 2 ~ "02",
                            day == 7 ~ "07",
                            day != 1 | 2 | 7 ~ as.character(day))) %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = day, y = TTRavg, color = treatment, shape = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_jitter(position = position_dodge(width = 0.75)) +
  geom_hline(aes(yintercept = boxplot.stats(modTTR$TTRavg)$stats[5]), lty = 2, color = "black") +
  ylab("Average Time-to-Right (s)") +
  scale_x_discrete(name = "Day",
                   breaks = c("0", "01", "02", "07", "12", "14", "19", "21", "26", "28", "42", "49"),
                   labels = c("0", "1", "2", "7", "12", "14", "19", "21", "26", "28", "42", "49")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) #Select unique day, treatment, and TTRavg data. Replace numbers with characters to facilitate better ordering. Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Add horizontal line for boxplot outlier threshold. Assign colors to each treatment. Increase base font size.
ggsave("figures/time-to-right-avg-boxplot.pdf", height = 8.5, width = 11)
```
# Individual-level analysis

## Respirometry crabs

I have 27 individuals (three per tank) with TTR and respirometry data! I'm going to examine that subset to understand individual variation within each treatment, and how that may or may not change over time.

```{r}
modTTRSubsetR <- modTTR %>%
  filter(., respirometry == "Y") %>%
  unique(.) #Subset data for crabs used in respirometry and TTR
head(modTTRSubsetR)
nrow(modTTRSubsetR)
```

First things first: I want to understand if there are certain individuals that vary more over time! The simplest way to do this is to just plot the data.

```{r}
modTTRSubsetR %>%
  dplyr::select(., c(crab.ID, day, tank, treatment, TTRavg)) %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment == "15C" ~ "15C",
                                  treatment == "25C" ~ "25C")) %>%
  ggplot(., mapping = aes(x = day, y = TTRavg, group = crab.ID, color = treatment, shape = treatment)) +
  geom_point(size = 1, alpha = 0.75) + geom_line(linetype = 3) +
  facet_wrap(vars(treatment, tank), ncol = 3) +
  scale_x_continuous(name = "Day",
                     breaks = c(seq(0, 42, 14), 49),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Individual Time-to-Right (s)",
                     breaks = c(0, seq(1, 5, 2), seq(5, 15, 5))) +
  # scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(strip.text.x = element_blank(),
                                        strip.background = element_blank()) #Plot TTR for each individual crab that was tracked over the entire experiment. Facet by tank and treatment so it's easier to visualize. Assign colors to each treatment.
ggsave("figures/time-to-right-avg-individuals.pdf", height = 8.5, width = 11)
```

Alright, this plot tells us what we already know: that there's more variation in the 5ºC than the other two.

I also want to look at difference in TTR over time by looking at the difference in TTR from the average...

```{r}
modTTRSubsetR %>%
  dplyr::select(., c(crab.ID, day, tank, treatment, TTRavg, TTRavgFull)) %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment == "15C" ~ "15C",
                                  treatment == "25C" ~ "25C")) %>%
  ggplot(., mapping = aes(x = day, y = TTRavg - TTRavgFull, group = crab.ID, color = treatment, shape = treatment)) +
  geom_point(size = 1, alpha = 0.75) + geom_line(linetype = 3) +
  facet_wrap(vars(treatment, tank), ncol = 3) +
  scale_x_continuous(name = "Day",
                     breaks = c(seq(0, 42, 14), 49),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Difference in Time-to-Right (s)",
                     breaks = seq(-5, 10, 5)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(strip.text.x = element_blank(),
                                        strip.background = element_blank()) #Plot difference in individual TTR from average TTR for each individual crab that was tracked over the entire experiment. Facet by tank and treatment so it's easier to visualize. Assign colors to each treatment.
ggsave("figures/time-to-right-avg-individuals-diff.pdf", height = 8.5, width = 11)
```

```{r}
modTTRSubsetR %>%
  dplyr::select(., c(crab.ID, day, tank, treatment, TTRavg, TTRavgFull, final.genotype)) %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment == "15C" ~ "15C",
                                  treatment == "25C" ~ "25C")) %>%
  ggplot(., mapping = aes(x = day, y = TTRavg - TTRavgFull, group = crab.ID, color = treatment, shape = final.genotype)) +
  geom_point(size = 1, alpha = 0.75) + geom_line(linetype = 3) +
  facet_wrap(vars(treatment, tank), ncol = 3) +
  scale_x_continuous(name = "Day",
                     breaks = c(seq(0, 42, 14), 49),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Difference in Time-to-Right (s)",
                     breaks = seq(-5, 10, 5)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(strip.text.x = element_blank(),
                                        strip.background = element_blank()) #Plot difference in individual TTR from average TTR for each individual crab that was tracked over the entire experiment. Facet by tank and treatment so it's easier to visualize. Assign colors to each treatment.
ggsave("figures/time-to-right-avg-individuals-diff-genotype.pdf", height = 8.5, width = 11)
```

...and percent change from the average.

```{r}
modTTRSubsetR %>%
  dplyr::select(., c(crab.ID, day, tank, treatment, TTRavg, TTRavgFull)) %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment == "15C" ~ "15C",
                                  treatment == "25C" ~ "25C")) %>%
  ggplot(., mapping = aes(x = day, y = ((TTRavg - TTRavgFull)/TTRavgFull)*100, group = crab.ID, color = treatment, shape = treatment)) +
  geom_point(size = 1, alpha = 0.75) + geom_line(linetype = 3) +
  facet_wrap(vars(treatment, tank), ncol = 3, scale = "free_y") +
  scale_x_continuous(name = "Day",
                     breaks = c(seq(0, 42, 14), 49),
                     limits = c(0, 49)) +
  scale_y_continuous(name = "Percent Change in Time-to-Right") +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(strip.text.x = element_blank(),
                                        strip.background = element_blank()) #Plot difference in individual TTR from average TTR for each individual crab that was tracked over the entire experiment. Facet by tank and treatment so it's easier to visualize. Assign colors to each treatment.
ggsave("figures/time-to-right-avg-individuals-percChange.pdf", height = 8.5, width = 11)
```

## Genotype analysis

I'm going to examine the effect of genotype on TTR in a few ways. 

### Average TTR

I'm going to start by looking the influnce of genotype variables on overall TTR:

1. Genotype
2. Presence of "C" (warm-adapted allele) (the inverse )

```{r}
modTTRGenotype <- modTTR %>%
  mutate(., presenceC = case_when(final.genotype == "CC" ~ "Y",
                                  final.genotype == "CT" ~ "Y",
                                  final.genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(final.genotype == "CC" ~ "N",
                                  final.genotype == "CT" ~ "Y",
                                  final.genotype == "TT" ~ "Y")) #Subset data with genotype information. Add two columns for presence of C or T allele
head(modTTRGenotype)
```

#### Full genotype 

```{r}
TTRmodelGenotype <- lmer(log(TTRavg) ~ treatment + day + treatment:day + 
                           final.genotype +
                           as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                           (1|crab.ID), 
                         data = modTTRGenotype, REML = FALSE) #Run model with treatment, timepoint, their interaction, sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRmodelGenotype) #Look at model output
#Individual crab still explains less than model residuals
```

```{r}
TTRnullGenotype <- lmer(log(TTRavg) ~ treatment + day + treatment:day + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTRGenotype, REML = FALSE) #Run model without interaction to identify significance of predictor. The full model constructed does not include an interaction
anova(TTRnullGenotype, TTRmodelGenotype) #Full genotype is not a significant predictor
```

#### Presence of C or T

```{r}
TTRmodelAllele <- lmer(log(TTRavg) ~ treatment + day + treatment:day + 
                         presenceC + presenceT +
                         as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                         (1|crab.ID), 
                       data = modTTRGenotype, REML = FALSE) #Run model with treatment, timepoint, their interaction, sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRmodelAllele) #Look at model output
#Individual crab still explains less than model residuals
```

```{r}
TTRnullAlleleC <- lmer(log(TTRavg) ~ treatment + day + treatment:day + presenceT + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTRGenotype, REML = FALSE) #Run model without interaction to identify significance of predictor. The full model constructed does not include an interaction
anova(TTRnullAlleleC, TTRmodelAllele) #Presence of C is not a significant predictor
```

```{r}
TTRnullAlleleT <- lmer(log(TTRavg) ~ treatment + day + treatment:day + presenceC + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTRGenotype, REML = FALSE) #Run model without interaction to identify significance of predictor. The full model constructed does not include an interaction
anova(TTRnullAlleleT, TTRmodelAllele) #Presence of T is not a significant predictor
```

```{r}
TTRGenotypeModelComparisons <- rbind(broom::tidy(anova(TTRnullGenotype, TTRmodelGenotype)),
                                     broom::tidy(anova(TTRnullAlleleC, TTRmodelAllele)),
                                     broom::tidy(anova(TTRnullAlleleT, TTRmodelAllele))) #Create a table of model comparison output
TTRGenotypeModelComparisons
```

```{r}
write.csv(TTRGenotypeModelComparisons, "ttr-genotype-model-comparison-output.csv", quote = FALSE, row.names = FALSE) #Save model comparison table
```

#### Plot

No genotype variable has a significant influence on average TTR. Can we see if any of our outliers in our average TTR boxplots are associated with a particular genotype?

```{r}
facet_labels <- c("05C" = "5ºC",
                  "15C" = "15ºC",
                  "25C" = "25ºC") #Assign labels for facets
```

```{r}
modTTRGenotype %>%
  dplyr::select(., c(day, treatment, TTRavg, final.genotype)) %>%
  distinct(.) %>%
  filter(., treatment != "15C") %>%
  mutate(., day = case_when(day == 1 ~ "01",
                            day == 2 ~ "02",
                            day == 7 ~ "07",
                            day != 1 | 2 | 7 ~ as.character(day))) %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = day, y = TTRavg, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, nrow = 3, scales = "free_y", labeller = labeller(treatment = facet_labels)) +
  ylab("Average Time-to-Right (s)") +
  scale_x_discrete(name = "Day",
                   breaks = c("0", "01", "02", "07", "12", "14", "19", "21", "26", "28", "42", "49"),
                   labels = c("0", "1", "2", "7", "12", "14", "19", "21", "26", "28", "42", "49")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) #Select unique day, treatment, and TTRavg data. Replace numbers with characters to facilitate better ordering. Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Add horizontal line for boxplot outlier threshold. Assign colors to each treatment. Increase base font size.
ggsave("figures/time-to-right-avg-boxplot-genotype.pdf", height = 8.5, width = 11)
```

### Difference in TTR

I'm going to do a similar analysis, but this time look at the effects of genotype on the difference in TTR between days 2 and 7, days 2 and 21, and days 2 and 42. Although the 5ºC treatment was run for 49 days, since we know time has a significant influence on TTR I'm going to use the same time point for all variables. Looking at differences with day 7 can represent short-term differences, while days 21 and 42 would be longer-term differences. Day 21 is also a nice parallel to the three-week experiment run in 2022. I also have day 0 data for some of the crabs.

```{r}
modTTRSubsetDiff <- modTTRGenotype %>%
  select(., day, crab.ID, TTRavg, treatment, final.genotype, presenceC, presenceT) %>%
  filter(., day == 0 | day == 2 | day == 7 | day == 21 | day == 42) %>%
  pivot_wider(., names_from = day, values_from = TTRavg, names_prefix = "day") %>%
  mutate(., day2v0 = day2 - day0) %>%
  mutate(., day7v0 = day7 - day0) %>%
  mutate(., day21v0 = day21 - day0) %>%
  mutate(., day42v0 = day42 - day0) %>%
  mutate(., day7v2 = day7 - day2) %>%
  mutate(., day21v2 = day21 - day2) %>%
  mutate(., day42v2 = day42 - day2) #For subset of the crabs, select day, crab ID, average TTR, treatmet, and genotype information. Filter days of interest and pivot wider, using days as columns and values from TTRavg. Add "day" as a prefix to all columns. Get the difference in TTR for comparisons of interest.
head(modTTRSubsetDiff)
```

```{r}
modTTRSubsetDiffStats <- modTTRSubsetDiff %>%
  filter(., is.na(day0) == FALSE & is.na(day2) == FALSE & is.na(day7) == FALSE) %>%
  select(., -c(day0, day2, day7, day21, day42, day7v2, day21v2, day42v2)) %>%
  pivot_longer(., cols = c(day2v0, day7v0, day21v0, day42v0), names_to = "day", values_to = "TTRdiff") %>%
  mutate(., day = gsub(pattern = "day", replacement = "", x = day)) %>%
  mutate(., day = gsub(pattern = "v0", replacement = "", x = day)) %>%
  mutate(., day = as.numeric(day)) %>%
  filter(., is.na(TTRdiff) == FALSE) %>%
  left_join(., (modTTRGenotype %>%
                  dplyr::select(crab.ID, treatment, day, sex, integument.cont, weight, treatment, carapace.width, missing.swimmer, final.genotype, presenceC, presenceT)),
            by = c("crab.ID", "treatment", "final.genotype", "presenceC", "presenceT", "day"))
#Take difference in TTR information and subset crabs with data for days 0, 2, and 7. Remove extraneous columns. Pivot data longer with values in TTRdiff and day in a new column. Remove extra characters from day values and convert into a numeric column
head(modTTRSubsetDiffStats) #Confirm dataframe creation
nrow(modTTRSubsetDiffStats) #72 data points
```

```{r}
hist(modTTRSubsetDiffStats$TTRdiff)
hist(log(modTTRSubsetDiffStats$TTRdiff))
#Non-transformed data is more normalized than log-transformed data
```

```{r}
head(modTTRSubsetDiffStats) #Confirm dataframe creation
```

#### Treatment, day, and treatment x day

```{r}
TTRDiffmodel <- lmer(TTRdiff ~ treatment + day + treatment:day + 
                   as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                   (1|crab.ID), 
                 data = modTTRSubsetDiffStats, REML = FALSE) #Run model
summary(TTRDiffmodel) #Look at model output.
```
```{r}
TTRnullDiffTreatment <- lmer(TTRdiff ~ day + 
                   as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                   (1|crab.ID), 
                 data = modTTRSubsetDiffStats, REML = FALSE) #Run null model without treatment to identify significance of predictor
anova(TTRnullDiffTreatment, TTRDiffmodel) #Treatment is a significant predictor
```

```{r}
TTRnullDiffDay <- lmer(TTRdiff ~ treatment + 
                   as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                   (1|crab.ID), 
                 data = modTTRSubsetDiffStats, REML = FALSE) #Run null model without treatment to identify significance of predictor
anova(TTRnullDiffDay, TTRDiffmodel) #Day is not a significant predictor
```

```{r}
TTRnullDiffInteraction <- lmer(TTRdiff ~ treatment + day + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTRSubsetDiffStats, REML = FALSE) #Run model without interaction to identify significance of predictor. The full model constructed does not include an interaction
anova(TTRnullDiffInteraction, TTRDiffmodel) #Interaction is not a significant predictor
```

```{r}
TTRDiffModelComparisons<- rbind(broom::tidy(anova(TTRnullDiffTreatment, TTRDiffmodel)),
                            broom::tidy(anova(TTRnullDiffDay, TTRDiffmodel)),
                            broom::tidy(anova(TTRnullDiffInteraction, TTRDiffmodel))) #Create table for model comparison output
TTRDiffModelComparisons
```

```{r}
write.csv(TTRDiffModelComparisons, "ttr-diff-base-comparison-stat-output.csv", quote = FALSE, row.names = FALSE) #Save model output
```

#### Full genotype

```{r}
TTRdiffModelGenotype <- lmer(TTRdiff ~ treatment + 
                               final.genotype +
                               as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                               (1|crab.ID), 
                             data = modTTRSubsetDiffStats, REML = FALSE) #Run model with treatment, timepoint, their interaction, sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRdiffModelGenotype) #Look at model output
```
```{r}
TTRdiffNullGenotype <- lmer(TTRdiff ~ treatment + 
                              as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                              (1|crab.ID), 
                            data = modTTRSubsetDiffStats, REML = FALSE)
anova(TTRdiffNullGenotype, TTRdiffModelGenotype) #Final genotype is not a signficiant predictor of difference in TTR
```

#### Presence of C or T

```{r}
TTRdiffModelAllele <- lmer(TTRdiff ~ treatment + 
                             presenceC + presenceT +
                             as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                             (1|crab.ID), 
                           data = modTTRSubsetDiffStats, REML = FALSE) #Run model with treatment, timepoint, their interaction, sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRdiffModelAllele) #Look at model output
```

```{r}
TTRdiffNullAlleleC <- lmer(TTRdiff ~ treatment +
                             as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                             presenceT +
                             (1|crab.ID), 
                           data = modTTRSubsetDiffStats, REML = FALSE)
anova(TTRdiffNullAlleleC, TTRdiffModelAllele) #C presence is not a signficiant predictor of difference in TTR
```

```{r}
TTRdiffNullAlleleT <- lmer(TTRdiff ~ treatment + 
                             as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                             presenceC +
                             (1|crab.ID), 
                           data = modTTRSubsetDiffStats, REML = FALSE)
anova(TTRdiffNullAlleleT, TTRdiffModelAllele) #T presence is not a signficiant predictor of difference in TTR
```

```{r}
TTRdiffGenotypeModelComparisons <- rbind(broom::tidy(anova(TTRdiffNullGenotype, TTRdiffModelGenotype)),
                                 broom::tidy(anova(TTRdiffNullAlleleC, TTRdiffModelAllele)),
                                 broom::tidy(anova(TTRdiffNullAlleleT, TTRdiffModelAllele))) #Create a table of model comparison output
TTRdiffGenotypeModelComparisons
```

```{r}
write.csv(TTRdiffGenotypeModelComparisons, "ttr-diff-genotype-comparison-output.csv", quote = FALSE, row.names = FALSE) #Save model comparison table
```

#### Plot

##### Facet by genotype

```{r}
modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = treatment, y = day7v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Individual TTR (s)", title = "Day 7 vs. Day 2") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/time-to-right-average-individuals-genotype-day7v2.pdf", height = 8.5, width = 11)
```

```{r}
modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = treatment, y = day21v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Individual TTR (s)", title = "Day 21 vs. Day 2") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/time-to-right-average-individuals-genotype-day21v2.pdf", height = 8.5, width = 11)
```

```{r}
modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = treatment, y = day42v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "Difference in Individual TTR (s)", title = "Day 42 vs. Day 2") +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/time-to-right-average-individuals-genotype-day42v2.pdf", height = 8.5, width = 11)
```

```{r}
day7vs2Plot <- modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = treatment, y = day7v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "", y = "", title = "A. Day 7 vs. Day 2") +
  scale_y_continuous(breaks = seq(-5, 15, 5),
                     limits = c(-5,15)) +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none",
                                        axis.ticks.x = element_blank(),
                                        axis.text.x = element_blank())
day7vs2Plot
```

```{r}
day21vs2Plot <- modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = treatment, y = day21v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "", y = "Difference in Individual TTR (s)", title = "B. Day 21 vs. Day 2") +
  scale_y_continuous(breaks = seq(-1,5,1),
                     limits = c(-1,5)) +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none",
                                        axis.ticks.x = element_blank(),
                                        axis.text.x = element_blank())
day21vs2Plot
```

```{r}
day42v2Plot <- modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = treatment, y = day42v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = treatment), size = 2) +
  facet_wrap(. ~ final.genotype) + 
  labs(x = "Temperature (ºC)", y = "", title = "C. Day 42 vs. Day 2") +
  scale_y_continuous(breaks = seq(-1,6,1),
                     limits = c(-1,6)) +
  scale_x_discrete(breaks = c("05C", "15C", "25C"),
                   labels = c("5", "15", "25")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
day42v2Plot
```

```{r}
day7vs2Plot / day21vs2Plot / day42v2Plot
ggsave("figures/time-to-right-average-individuals-genotype-multipanel.pdf", height = 11, width = 8.5)
```

##### Facet by temperature

```{r}
modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = final.genotype, y = day7v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) +
  labs(x = "Genotype", y = "Difference in Individual TTR (s)", title = "Day 7 vs. Day 2") +
  scale_x_discrete(breaks = c("CC", "CT", "TT")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/time-to-right-average-individuals-genotype-bytemp-day7v2.pdf", height = 8.5, width = 11)
```

```{r}
modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = final.genotype, y = day21v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) +
  labs(x = "Genotype", y = "Difference in Individual TTR (s)", title = "Day 21 vs. Day 2") +
  scale_x_discrete(breaks = c("CC", "CT", "TT")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/time-to-right-average-individuals-genotype-bytemp-day21v2.pdf", height = 8.5, width = 11)
```

```{r}
modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = final.genotype, y = day42v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) +
  labs(x = "Genotype", y = "Difference in Individual TTR (s)", title = "Day 42 vs. Day 2") +
  scale_x_discrete(breaks = c("CC", "CT", "TT")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
ggsave("figures/time-to-right-average-individuals-genotype-bytemp-day42v2.pdf", height = 8.5, width = 11)
```

```{r}
day7vs2byTempPlot <- modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = final.genotype, y = day7v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) + 
  labs(x = "", y = "", title = "A. Day 7 vs. Day 2") +
  scale_x_discrete(breaks = c("CC", "CT", "TT")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(legend.position = "none",
                                        axis.ticks.x = element_blank(),
                                        axis.text.x = element_blank())
day7vs2byTempPlot
```

```{r}
day21vs2byTempPlot <- modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = final.genotype, y = day21v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) + 
  labs(x = "", y = "Difference in Individual TTR (s)", title = "B. Day 21 vs. Day 2") +
  scale_x_discrete(breaks = c("CC", "CT", "TT")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(legend.position = "none",
                                        axis.ticks.x = element_blank(),
                                        axis.text.x = element_blank())
day21vs2byTempPlot
```

```{r}
day42v2byTempPlot <- modTTRSubsetDiff %>%
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment)) %>%
  ggplot(mapping = aes(x = final.genotype, y = day42v2, color = treatment)) +
  geom_boxplot(outlier.shape = NA) + geom_point(aes(shape = final.genotype), size = 2) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) + 
  labs(x = "Genotype", y = "", title = "C. Day 42 vs. Day 2") +
  scale_x_discrete(breaks = c("CC", "CT", "TT")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "15C", "25C"),
                     labels = c("5", "15", "25")) +
  scale_shape_manual(values = c(3, 4, 1),
                     name = "Genotype",
                     breaks = c("CC", "CT", "TT"),
                     labels = c("CC", "CT", "TT")) +
  theme_classic(base_size = 15) + theme(legend.position = "none")
day42v2byTempPlot
```

```{r}
day7vs2byTempPlot / day21vs2byTempPlot / day42v2byTempPlot
ggsave("figures/time-to-right-average-individuals-genotype-byTemp-multipanel.pdf", height = 11, width = 8.5)
```

## Q10 analysis

Q10 is a metric used to quantify temperature sensitivity, generally defined as the change in a physiological response over a 10 degree temperature interval. For most organisms, Q10 is around 2 (a two-fold change in a physiological or chemical response due to a 10 degree temperature change). I will use the full dataset to calculate Q10 values between day 0 and 2, day 0 and 7, day 0 and 21, and day 0 and 42. I can then investigate how genotype influences Q10.

```{r}
modTTRQ10 <- modTTR %>%
  select(., day, crab.ID, TTRavg, treatment, final.genotype) %>%
  mutate(., presenceC = case_when(final.genotype == "CC" ~ "Y",
                                  final.genotype == "CT" ~ "Y",
                                  final.genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(final.genotype == "CC" ~ "N",
                                  final.genotype == "CT" ~ "Y",
                                  final.genotype == "TT" ~ "Y")) %>%
  filter(., day == 0 | day == 2 | day == 7 | day == 21 | day == 42) %>%
  filter(., treatment != "15C") %>%
  pivot_wider(., names_from = day, values_from = TTRavg, names_prefix = "day") %>%
  filter(., is.na(day0) == FALSE) %>% 
  mutate(temperature = case_when(treatment == "15C" ~ 15,
                                 treatment == "25C" ~ 25,
                                 treatment == "5C" ~ 5)) %>%
  arrange(., temperature) %>%
  mutate(., day2_Q10 = Q10(R1 = day0, 
                           R2 = day2, 
                           T1 = 15, 
                           T2 = temperature)) %>%
  mutate(., day7_Q10 = Q10(R1 = day0, 
                           R2 = day7, 
                           T1 = 15, 
                           T2 = temperature)) %>%
  mutate(., day21_Q10 = Q10(R1 = day0, 
                            R2 = day21, 
                            T1 = 15, 
                            T2 = temperature)) %>%
  mutate(., day42_Q10 = Q10(R1 = day0, 
                            R2 = day42, 
                            T1 = 15, 
                            T2 = temperature)) %>% 
  select(., crab.ID, treatment, final.genotype, presenceC, presenceT, day2_Q10, day7_Q10, day21_Q10, day42_Q10) %>%
  pivot_longer(., cols = !c(crab.ID, treatment, final.genotype, presenceC, presenceT), names_to = "day", values_to = "Q10") %>%
  filter(., is.na(Q10) == FALSE) %>%
  mutate(., day = gsub(x = day, pattern = "_Q10", replacement = "")) %>%
  mutate(., day = gsub(x = day, pattern = "day", replacement = "")) %>%
  mutate(., day = case_when(day == "2" ~ "02",
                            day == "7" ~ "07",
                            day != "2" | day != "7" ~ day)) %>% 
  mutate(., treatment = case_when(treatment == "5C" ~ "05C",
                                  treatment != "5C" ~ treatment))
#Select columns of interest. Add columns for presence of C or T alleles. Filter days of interest, remove 15C crabs, and pivot wider. Remove crabs without a day 0 measurement. Add a column for temperature based on the treatment column, and arrange data by temperature. Use the Q10 function within the respirometry package to calculate Q10 values for day 0 vs. day 2, 7, 21, and 42. Remove any rows without a day 2 Q10 value. Select columns of interest and pivot longer. Remove any rows without a Q10 value. Use a series of gsub to modify day column and convert to a character format that would be organized numerically. Use a similar approach for treatment.
head(modTTRQ10)
length(modTTRQ10$crab.ID %>% unique(.)) #18 crabs
```

```{r}
modTTRQ10 %>%
  ggplot(., mapping = aes(x = day, y = Q10, color = treatment, shape = treatment, group = crab.ID)) +
  geom_point(size = 2) + geom_line(lty = 3) +
  facet_wrap(. ~ treatment, scales = "free_y", labeller = labeller(treatment = facet_labels)) +
  scale_x_discrete(name = "Day",
                   breaks = c("02", "07", "21", "42"),
                   labels = c("2", "7", "21", "42")) +
  scale_color_manual(values = c(plotColors[3], plotColors[1]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 17),
                     guide = "none") +
  theme_classic(base_size = 15) #Plot Q10 data with day on the x-axis, Q10 on the y-axis, and color and shape defined by treatment. Group by crab.ID. Add points and lines connecting values for each crab. Facet by treatment, allow y-axis to vary by each facet, and include facet labels. Add x-axis label and specify x-axis tick labels. Add shape and color values for each treatment but do not include a legend.
ggsave("figures/time-to-right-average-individuals-Q10.pdf", height = 8.5, width = 11)
```

# TO DO LIST

- FIX NAS IN MODTTR BY GOING THROUGH AND FIXING MISLABELLED CRABS IN TTR DATA.
